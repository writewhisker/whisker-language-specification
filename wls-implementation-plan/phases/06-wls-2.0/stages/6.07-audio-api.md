# Stage 6.07: Audio/Media API

## Objective
Implement first-class audio controls.

## Files to Create
- `packages/story-player/src/AudioManager.ts`
- `lib/whisker/runtime/audio.lua`

## Prompt

```
Create audio API:

1. Specification:

## Audio API (WLS 2.0)

First-class audio controls in stories.

### Declaration

```whisker
@audio: bgm = "music/theme.mp3" loop volume:0.7
@audio: sfx = "sounds/door.wav"
@audio: voice = "dialogue/intro.mp3" preload
```

### Playback

```whisker
{do whisker.audio.play("bgm")}
{do whisker.audio.stop("bgm")}
{do whisker.audio.pause("bgm")}
{do whisker.audio.setVolume("bgm", 0.5)}
```

### Transitions

```whisker
{do whisker.audio.fadeIn("bgm", 2000)}
{do whisker.audio.fadeOut("bgm", 1000)}
{do whisker.audio.crossfade("bgm", "battle_music", 2000)}
```

### Channels

- `bgm` - Background music (one at a time)
- `sfx` - Sound effects (multiple simultaneous)
- `voice` - Voice/dialogue (one at a time)
- `ambient` - Ambient sounds (multiple simultaneous)

2. TypeScript implementation:

interface AudioTrack {
  id: string;
  url: string;
  channel: 'bgm' | 'sfx' | 'voice' | 'ambient';
  loop: boolean;
  volume: number;
  preload: boolean;
}

export class AudioManager {
  private tracks: Map<string, AudioTrack> = new Map();
  private playing: Map<string, HTMLAudioElement> = new Map();

  registerTrack(track: AudioTrack): void {
    this.tracks.set(track.id, track);
    if (track.preload) {
      this.preload(track.id);
    }
  }

  play(id: string): void {
    const track = this.tracks.get(id);
    if (!track) throw new Error(\`Unknown audio: \${id}\`);

    // Stop other tracks on same exclusive channel
    if (track.channel === 'bgm' || track.channel === 'voice') {
      this.stopChannel(track.channel);
    }

    const audio = new Audio(track.url);
    audio.loop = track.loop;
    audio.volume = track.volume;
    audio.play();
    this.playing.set(id, audio);
  }

  fadeOut(id: string, duration: number): Promise<void> {
    return new Promise(resolve => {
      const audio = this.playing.get(id);
      if (!audio) { resolve(); return; }

      const startVolume = audio.volume;
      const steps = 20;
      const stepDuration = duration / steps;
      let step = 0;

      const interval = setInterval(() => {
        step++;
        audio.volume = startVolume * (1 - step / steps);
        if (step >= steps) {
          clearInterval(interval);
          audio.pause();
          this.playing.delete(id);
          resolve();
        }
      }, stepDuration);
    });
  }

  crossfade(fromId: string, toId: string, duration: number): void {
    this.fadeOut(fromId, duration);
    this.play(toId);
    // Fade in is handled by starting at 0 and increasing
  }
}

3. Lua implementation for non-web platforms.
```

## Expected Output
~180 lines TypeScript + ~120 lines Lua.

## Verification
```bash
pnpm --filter @writewhisker/story-player test -- --run audio
```

## Next Stage
6.08-text-effects.md
