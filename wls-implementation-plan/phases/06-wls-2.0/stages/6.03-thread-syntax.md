# Stage 6.03: Thread Syntax and Parser

## Objective
Add thread syntax to parser (spawn, await, thread passages).

## Files to Modify
- `packages/parser/src/whisker.pegjs`
- `lib/whisker/parser/ws_parser.lua`
- `spec/02-FLOW-CONTROL.md`

## Prompt

```
Add thread syntax to parsers:

1. Specification (spec/02-FLOW-CONTROL.md):

## Threads (WLS 2.0)

Threads allow parallel narrative execution.

### Spawning Threads

```whisker
:: Dinner
-> AmbientDining    // Spawn background thread
The waiter approaches.
+ [Order wine] -> Wine
+ [Order water] -> Water

== AmbientDining    // Thread passage (== prefix)
{~|Music plays.|Glasses clink.|Laughter nearby.}
-> AmbientDining    // Loop
```

### Thread Passages

Thread passages use `==` instead of `::`:
- Run independently of main thread
- Can loop with `-> Self`
- Terminate with `-> END` or when parent exits

### Await

Wait for a thread to complete:

```whisker
:: Story
-> Investigation   // Spawn
{await Investigation}  // Wait for completion
Now we know the truth.
```

### Thread-Local Variables

Use `$_thread.varname` for thread-local state.

2. Update TypeScript parser:

// Thread passage declaration
ThreadPassage
  = "==" _ name:PassageName _ tags:Tags? EOL content:PassageContent* {
      return {
        type: 'thread_passage',
        name,
        tags: tags || [],
        content,
        line: location().start.line
      };
    }

// Await expression
AwaitExpr
  = "{await" _ threadName:Identifier _ "}" {
      return {
        type: 'await',
        thread: threadName,
        line: location().start.line
      };
    }

3. Update Lua parser with same patterns.

4. Add tests for thread syntax parsing.
```

## Expected Output
~100 lines spec + ~80 lines grammar + ~80 lines Lua.

## Verification
```bash
pnpm --filter @writewhisker/parser test -- --run thread
```

## Next Stage
6.04-list-state-machine.md
