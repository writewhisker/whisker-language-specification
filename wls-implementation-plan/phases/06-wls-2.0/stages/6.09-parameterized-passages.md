# Stage 6.09: Parameterized Passages

## Objective
Allow passages to accept parameters.

## Files to Modify
- `packages/parser/src/whisker.pegjs`
- `packages/story-player/src/StoryPlayer.ts`
- `lib/whisker/parser/ws_parser.lua`

## Prompt

```
Implement parameterized passages:

1. Specification:

## Parameterized Passages (WLS 2.0)

Passages can accept parameters for reusable content.

### Declaration

```whisker
:: Describe(item, quality)
You examine the $item carefully.
{quality == "good"}
It's in excellent condition.
{else}
It's seen better days.
{/}
```

### Calling

With tunnels:
```whisker
:: Inventory
-> Describe("sword", "good") ->
-> Describe("shield", "worn") ->
```

With links:
```whisker
+ [Examine sword] -> Describe("sword", "good")
```

### Default Values

```whisker
:: Greet(name, title = "friend")
Hello, $title $name!
```

### Usage

```whisker
-> Greet("Alice") ->           // "Hello, friend Alice!"
-> Greet("Bob", "Sir") ->      // "Hello, Sir Bob!"
```

2. Parser updates:

PassageDeclaration
  = "::" _ name:PassageName params:PassageParams? _ tags:Tags? EOL {
      return {
        type: 'passage',
        name,
        params: params || [],
        tags: tags || [],
        line: location().start.line
      };
    }

PassageParams
  = "(" _ first:Param rest:("," _ Param)* _ ")" {
      return [first, ...rest.map(r => r[2])];
    }

Param
  = name:Identifier defaultValue:("=" _ Expression)? {
      return { name, default: defaultValue?.[2] };
    }

// Passage call with arguments
PassageCall
  = "->" _ name:PassageName args:CallArgs? _ "->"? {
      return {
        type: 'passage_call',
        target: name,
        args: args || [],
        isTunnel: // check for trailing ->
      };
    }

CallArgs
  = "(" _ first:Expression rest:("," _ Expression)* _ ")" {
      return [first, ...rest.map(r => r[2])];
    }

3. Runtime updates:

navigateToPassage(name: string, args: unknown[] = []): void {
  const passage = this.findPassage(name);
  if (!passage) throw new Error(\`Passage not found: \${name}\`);

  // Bind parameters to local variables
  if (passage.params) {
    for (let i = 0; i < passage.params.length; i++) {
      const param = passage.params[i];
      const value = args[i] ?? param.default;
      this.setLocalVariable(param.name, value);
    }
  }

  this.processPassage(passage);
}

4. Lua implementation.
```

## Expected Output
~100 lines grammar + ~80 lines runtime + ~80 lines Lua.

## Verification
```bash
pnpm --filter @writewhisker/parser test -- --run parameterized
pnpm --filter @writewhisker/story-player test -- --run parameterized
```

## Next Stage
6.10-2.0-corpus-tests.md
