# Stage 6.01: WLS 1.x to 2.0 Migration Tool

## Objective
Create migration tool for WLS 1.x stories to 2.0.

## Files to Create
- `tools/migrate-1x-to-2x.ts`
- `tools/migrate-1x-to-2x.lua`

## Prompt

```
Create migration tool for WLS 1.x to 2.0:

1. Create tools/migrate-1x-to-2x.ts:

import { parse as parse1x } from '@writewhisker/parser';
import * as fs from 'fs';

interface MigrationResult {
  content: string;
  changes: MigrationChange[];
  warnings: string[];
}

interface MigrationChange {
  type: 'rename' | 'syntax' | 'reserved_word';
  line: number;
  original: string;
  replacement: string;
  reason: string;
}

export function migrate(source: string): MigrationResult {
  const changes: MigrationChange[] = [];
  const warnings: string[] = [];
  let content = source;

  // Check for reserved words that become keywords in 2.0
  const reservedWords = ['thread', 'await', 'spawn', 'sync', 'channel'];
  for (const word of reservedWords) {
    const regex = new RegExp(`\\$${word}\\b`, 'g');
    if (regex.test(content)) {
      content = content.replace(regex, `$_${word}`);
      changes.push({
        type: 'reserved_word',
        line: 0,
        original: `$${word}`,
        replacement: `$_${word}`,
        reason: `'${word}' is reserved in WLS 2.0`
      });
    }
  }

  // LIST syntax changes (if any)
  // content = migrateListSyntax(content, changes);

  // Detect patterns that might need manual review
  if (content.includes('->->')) {
    // Already has tunnels, might interact with threads
    warnings.push('Story uses tunnels - review thread interactions');
  }

  return { content, changes, warnings };
}

// CLI interface
if (require.main === module) {
  const [,, inputFile, outputFile] = process.argv;

  if (!inputFile) {
    console.log('Usage: migrate-1x-to-2x <input.ws> [output.ws]');
    process.exit(1);
  }

  const source = fs.readFileSync(inputFile, 'utf-8');
  const result = migrate(source);

  console.log(\`Migration complete:\`);
  console.log(\`  Changes: \${result.changes.length}\`);
  console.log(\`  Warnings: \${result.warnings.length}\`);

  for (const change of result.changes) {
    console.log(\`  - \${change.original} -> \${change.replacement}: \${change.reason}\`);
  }

  for (const warning of result.warnings) {
    console.log(\`  ! \${warning}\`);
  }

  const output = outputFile || inputFile.replace('.ws', '.2x.ws');
  fs.writeFileSync(output, result.content);
  console.log(\`Written to: \${output}\`);
}

2. Create equivalent Lua version for whisker-core.

3. Add tests for migration scenarios.
```

## Expected Output
~150 lines TypeScript + ~100 lines Lua.

## Verification
```bash
npx tsx tools/migrate-1x-to-2x.ts sample-1x.ws
```

## Next Stage
6.02-thread-scheduler.md
