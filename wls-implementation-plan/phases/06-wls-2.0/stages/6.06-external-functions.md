# Stage 6.06: External Function Binding

## Objective
Allow stories to call host application functions.

## Files to Create
- `packages/story-player/src/ExternalFunctions.ts`
- `lib/whisker/runtime/external.lua`

## Prompt

```
Create external function binding:

1. Specification:

## External Functions (WLS 2.0)

Stories can call functions provided by the host application.

### Declaration

```whisker
EXTERNAL playSound(soundId: string)
EXTERNAL getUserName(): string
EXTERNAL saveAchievement(id: string, value: number)
```

### Usage

```whisker
:: Victory
{do playSound("fanfare")}
Congratulations, ${getUserName()}!
{do saveAchievement("game_complete", 100)}
```

### Host Registration

TypeScript:
```typescript
player.registerExternal('playSound', (id) => {
  audioManager.play(id);
});

player.registerExternal('getUserName', () => {
  return currentUser.name;
});
```

Lua:
```lua
player:register_external('playSound', function(id)
  audio:play(id)
end)
```

2. TypeScript implementation:

type ExternalFunction = (...args: unknown[]) => unknown | Promise<unknown>;

export class ExternalFunctionRegistry {
  private functions: Map<string, ExternalFunction> = new Map();
  private declarations: Map<string, FunctionDeclaration> = new Map();

  register(name: string, fn: ExternalFunction): void {
    this.functions.set(name, fn);
  }

  declare(decl: FunctionDeclaration): void {
    this.declarations.set(decl.name, decl);
  }

  async call(name: string, args: unknown[]): Promise<unknown> {
    const fn = this.functions.get(name);
    if (!fn) {
      throw new Error(\`External function not registered: \${name}\`);
    }

    // Type check arguments if declaration exists
    const decl = this.declarations.get(name);
    if (decl) {
      this.validateArgs(decl, args);
    }

    const result = fn(...args);
    return result instanceof Promise ? await result : result;
  }

  private validateArgs(decl: FunctionDeclaration, args: unknown[]): void {
    // Validate argument types match declaration
  }
}

interface FunctionDeclaration {
  name: string;
  params: { name: string; type: string }[];
  returnType?: string;
}

3. Parser updates for EXTERNAL declarations.
4. Lua implementation.
```

## Expected Output
~150 lines TypeScript + ~100 lines Lua.

## Verification
```bash
pnpm --filter @writewhisker/story-player test -- --run external
```

## Next Stage
6.07-audio-api.md
