# Stage 6.05: Timed Content System

## Objective
Implement timed content delays and scheduling.

## Files to Create
- `packages/story-player/src/TimedContentManager.ts`
- `lib/whisker/runtime/timed.lua`

## Prompt

```
Create timed content system:

1. Specification:

## Timed Content (WLS 2.0)

Content can be delayed or scheduled.

### Delay

```whisker
:: Suspense
You wait in darkness.

@delay 2s {
Footsteps echo in the distance.
}

@delay 4s {
A door creaks open.
}

@delay 6s {
+ [Hide!] -> Hide
+ [Confront them] -> Confront
}
```

### Repeat

```whisker
@every 1s {
The clock ticks.
}
```

### Controls

```whisker
{do whisker.timer.pause()}
{do whisker.timer.resume()}
{do whisker.timer.cancel("timer_id")}
```

2. TypeScript implementation:

export interface TimedBlock {
  id: string;
  delay: number;  // milliseconds
  content: PassageContent[];
  startTime?: number;
  repeat?: boolean;
}

export class TimedContentManager {
  private blocks: TimedBlock[] = [];
  private paused = false;
  private pauseTime?: number;

  schedule(delay: number, content: PassageContent[], repeat = false): string {
    const id = \`timer_\${Date.now()}\`;
    this.blocks.push({
      id,
      delay,
      content,
      startTime: Date.now(),
      repeat
    });
    return id;
  }

  tick(): PassageContent[] {
    if (this.paused) return [];

    const now = Date.now();
    const ready: PassageContent[] = [];

    this.blocks = this.blocks.filter(block => {
      const elapsed = now - (block.startTime || 0);
      if (elapsed >= block.delay) {
        ready.push(...block.content);
        if (block.repeat) {
          block.startTime = now;
          return true;
        }
        return false;
      }
      return true;
    });

    return ready;
  }

  pause(): void {
    this.paused = true;
    this.pauseTime = Date.now();
  }

  resume(): void {
    if (this.paused && this.pauseTime) {
      const pauseDuration = Date.now() - this.pauseTime;
      for (const block of this.blocks) {
        if (block.startTime) {
          block.startTime += pauseDuration;
        }
      }
    }
    this.paused = false;
  }

  cancel(id: string): void {
    this.blocks = this.blocks.filter(b => b.id !== id);
  }
}

3. Lua implementation and parser updates.
```

## Expected Output
~150 lines TypeScript + ~100 lines Lua.

## Verification
```bash
pnpm --filter @writewhisker/story-player test -- --run timed
```

## Next Stage
6.06-external-functions.md
