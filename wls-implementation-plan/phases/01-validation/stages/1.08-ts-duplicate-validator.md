# Stage 1.08: TypeScript - Duplicate Passages Validator

## Objective
Implement the DuplicatePassagesValidator for TypeScript.

## Files to Create
- `packages/story-validation/src/validators/DuplicatePassagesValidator.ts`
- `packages/story-validation/src/validators/DuplicatePassagesValidator.test.ts`

## Prompt

```
Create the DuplicatePassagesValidator in whisker-editor-web:

1. Create validator at:
/Users/jims/code/github.com/writewhisker/whisker-editor-web/packages/story-validation/src/validators/DuplicatePassagesValidator.ts

import type { Story } from '@writewhisker/story-models';
import type { StoryValidator, WLSValidationError } from '../types';
import { createValidationError } from '../types';

export class DuplicatePassagesValidator implements StoryValidator {
  name = 'DuplicatePassagesValidator';
  errorCodes = ['WLS-STR-003'];

  validate(story: Story): WLSValidationError[] {
    const errors: WLSValidationError[] = [];
    const seen = new Map<string, number>(); // name -> first line

    for (const passage of story.passages) {
      const normalizedName = passage.name.toLowerCase();

      if (seen.has(normalizedName)) {
        errors.push(createValidationError(
          'WLS-STR-003',
          [passage.name],
          { passage: passage.name, line: passage.line },
          { firstOccurrence: seen.get(normalizedName) }
        ));
      } else {
        seen.set(normalizedName, passage.line ?? 0);
      }
    }

    return errors;
  }
}

2. Create test file at:
/Users/jims/code/github.com/writewhisker/whisker-editor-web/packages/story-validation/src/validators/DuplicatePassagesValidator.test.ts

import { describe, it, expect } from 'vitest';
import { DuplicatePassagesValidator } from './DuplicatePassagesValidator';
import { parse } from '@writewhisker/parser';

describe('DuplicatePassagesValidator', () => {
  const validator = new DuplicatePassagesValidator();

  it('passes when no duplicates', () => {
    const story = parse(`
:: Start
Hello

:: Other
World
`);
    const errors = validator.validate(story);
    expect(errors).toHaveLength(0);
  });

  it('detects exact duplicate names', () => {
    const story = parse(`
:: Start
First

:: Start
Second
`);
    const errors = validator.validate(story);
    expect(errors).toHaveLength(1);
    expect(errors[0].code).toBe('WLS-STR-003');
  });

  it('detects case-insensitive duplicates', () => {
    const story = parse(`
:: Start
First

:: START
Second
`);
    const errors = validator.validate(story);
    expect(errors).toHaveLength(1);
  });

  it('reports all duplicates not just first', () => {
    const story = parse(`
:: Start
First

:: Start
Second

:: Start
Third
`);
    const errors = validator.validate(story);
    expect(errors).toHaveLength(2);
  });
});

3. Register in validators/index.ts:
Add DuplicatePassagesValidator to exports and default validator list.
```

## Expected Output
~60 lines validator + ~60 lines tests.

## Verification
```bash
cd ~/code/github.com/writewhisker/whisker-editor-web

# Run tests
pnpm --filter @writewhisker/story-validation test -- --run DuplicatePassagesValidator

# Should pass
```

## Next Stage
1.09-ts-self-link-validator.md
