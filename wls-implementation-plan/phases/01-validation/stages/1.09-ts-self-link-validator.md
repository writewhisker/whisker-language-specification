# Stage 1.09: TypeScript - Self Link Validator

## Objective
Implement the SelfLinkValidator for TypeScript.

## Files to Create
- `packages/story-validation/src/validators/SelfLinkValidator.ts`
- `packages/story-validation/src/validators/SelfLinkValidator.test.ts`

## Prompt

```
Create the SelfLinkValidator in whisker-editor-web:

1. Create validator at:
/Users/jims/code/github.com/writewhisker/whisker-editor-web/packages/story-validation/src/validators/SelfLinkValidator.ts

import type { Story } from '@writewhisker/story-models';
import type { StoryValidator, WLSValidationError } from '../types';
import { createValidationError } from '../types';

export class SelfLinkValidator implements StoryValidator {
  name = 'SelfLinkValidator';
  errorCodes = ['WLS-LNK-002'];

  validate(story: Story): WLSValidationError[] {
    const errors: WLSValidationError[] = [];

    for (const passage of story.passages) {
      // Check choices
      for (const choice of passage.choices ?? []) {
        if (this.isSelfLink(passage.name, choice.target)) {
          errors.push(createValidationError(
            'WLS-LNK-002',
            [passage.name],
            { passage: passage.name, line: choice.line }
          ));
        }
      }

      // Check inline links/redirects
      for (const link of passage.links ?? []) {
        if (this.isSelfLink(passage.name, link.target)) {
          errors.push(createValidationError(
            'WLS-LNK-002',
            [passage.name],
            { passage: passage.name, line: link.line }
          ));
        }
      }
    }

    return errors;
  }

  private isSelfLink(passageName: string, target: string): boolean {
    return target.toLowerCase() === passageName.toLowerCase();
  }
}

2. Create test file at:
/Users/jims/code/github.com/writewhisker/whisker-editor-web/packages/story-validation/src/validators/SelfLinkValidator.test.ts

import { describe, it, expect } from 'vitest';
import { SelfLinkValidator } from './SelfLinkValidator';
import { parse } from '@writewhisker/parser';

describe('SelfLinkValidator', () => {
  const validator = new SelfLinkValidator();

  it('passes when no self links', () => {
    const story = parse(`
:: Start
+ [Go] -> Other

:: Other
Content
`);
    const errors = validator.validate(story);
    expect(errors).toHaveLength(0);
  });

  it('detects self-link in choice', () => {
    const story = parse(`
:: Start
+ [Stay here] -> Start
`);
    const errors = validator.validate(story);
    expect(errors).toHaveLength(1);
    expect(errors[0].code).toBe('WLS-LNK-002');
  });

  it('detects case-insensitive self-link', () => {
    const story = parse(`
:: Start
+ [Loop] -> START
`);
    const errors = validator.validate(story);
    expect(errors).toHaveLength(1);
  });

  it('allows intentional self-links with condition', () => {
    // Self-links with conditions are often intentional loops
    // This validator still flags them - it's a warning not error
    const story = parse(`
:: Start
{$count < 3}
+ [Try again] -> Start
{/}
`);
    const errors = validator.validate(story);
    expect(errors).toHaveLength(1);
    expect(errors[0].severity).toBe('warning');
  });

  it('detects self-link in redirect', () => {
    const story = parse(`
:: Loop
-> Loop
`);
    const errors = validator.validate(story);
    expect(errors).toHaveLength(1);
  });
});

3. Register in validators/index.ts.
```

## Expected Output
~50 lines validator + ~60 lines tests.

## Verification
```bash
cd ~/code/github.com/writewhisker/whisker-editor-web

pnpm --filter @writewhisker/story-validation test -- --run SelfLinkValidator
```

## Next Stage
1.10-ts-dead-end-validator.md
