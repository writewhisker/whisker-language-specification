# Stage 1.18: Lua - Flow Validators

## Objective
Implement flow validators for Lua (FLW codes).

## Files to Create
- `lib/whisker/validators/flow.lua`
- `spec/validators/flow_spec.lua`

## Prompt

```
Create flow validators in whisker-core:

1. Create lib/whisker/validators/flow.lua:

local error_codes = require("whisker.validators.error_codes")
local create_error = error_codes.create_error

local M = {}

local TERMINAL_TARGETS = {
  END = true,
  BACK = true,
  RETURN = true
}

-- WLS-FLW-001: Dead end passages
M.DeadEndValidator = {
  name = "DeadEndValidator",
  error_codes = {"WLS-FLW-001"},

  validate = function(story)
    local errors = {}

    for _, passage in ipairs(story.passages or {}) do
      -- Skip terminal passages
      if TERMINAL_TARGETS[passage.name:upper()] then
        goto continue
      end

      local has_choices = passage.choices and #passage.choices > 0
      local has_links = passage.links and #passage.links > 0

      if not has_choices and not has_links then
        table.insert(errors, create_error(
          "WLS-FLW-001",
          { passage = passage.name, line = passage.line },
          passage.name
        ))
      end

      ::continue::
    end

    return errors
  end
}

-- WLS-FLW-003/004: Cycle detection
M.CycleDetectorValidator = {
  name = "CycleDetectorValidator",
  error_codes = {"WLS-FLW-003", "WLS-FLW-004"},

  validate = function(story)
    local errors = {}
    local graph = {}
    local passage_map = {}

    -- Build graph
    for _, passage in ipairs(story.passages or {}) do
      passage_map[passage.name:lower()] = passage
      local targets = {}

      for _, choice in ipairs(passage.choices or {}) do
        if choice.target then
          table.insert(targets, choice.target:lower())
        end
      end

      for _, link in ipairs(passage.links or {}) do
        if link.target then
          table.insert(targets, link.target:lower())
        end
      end

      graph[passage.name:lower()] = targets
    end

    -- DFS for cycles
    local visited = {}
    local rec_stack = {}
    local cycles = {}

    local function dfs(node, path)
      visited[node] = true
      rec_stack[node] = true
      table.insert(path, node)

      for _, neighbor in ipairs(graph[node] or {}) do
        if not visited[neighbor] then
          dfs(neighbor, {table.unpack(path)})
        elseif rec_stack[neighbor] then
          -- Found cycle
          local cycle = {}
          local in_cycle = false
          for _, n in ipairs(path) do
            if n == neighbor then in_cycle = true end
            if in_cycle then table.insert(cycle, n) end
          end
          table.insert(cycles, cycle)
        end
      end

      rec_stack[node] = nil
    end

    for node in pairs(graph) do
      if not visited[node] then
        dfs(node, {})
      end
    end

    -- Check if cycle is infinite loop
    local function is_infinite(cycle)
      for _, name in ipairs(cycle) do
        local passage = passage_map[name]
        if passage and passage.choices and #passage.choices > 0 then
          return false
        end
      end
      return true
    end

    -- Report cycles
    for _, cycle in ipairs(cycles) do
      local code = is_infinite(cycle) and "WLS-FLW-004" or "WLS-FLW-003"
      local path = table.concat(cycle, " -> ")
      table.insert(errors, create_error(
        code,
        { passage = cycle[1] },
        path
      ))
    end

    return errors
  end
}

return M

2. Create spec/validators/flow_spec.lua with tests.

3. Register in init.lua.
```

## Expected Output
~140 lines validators + ~80 lines tests.

## Verification
```bash
cd ~/code/github.com/writewhisker/whisker-core

busted spec/validators/flow_spec.lua
```

## Next Stage
1.19-lua-register-validators.md
