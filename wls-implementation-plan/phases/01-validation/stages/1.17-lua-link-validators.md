# Stage 1.17: Lua - Link Validators

## Objective
Implement link validators for Lua (LNK codes).

## Files to Create
- `lib/whisker/validators/links.lua`
- `spec/validators/links_spec.lua`

## Prompt

```
Create link validators in whisker-core:

1. Create lib/whisker/validators/links.lua:

local error_codes = require("whisker.validators.error_codes")
local create_error = error_codes.create_error

local M = {}

local SPECIAL_TARGETS = {
  START = true,
  END = true,
  BACK = true,
  RETURN = true
}

-- WLS-LNK-001: Dead links
M.DeadLinksValidator = {
  name = "DeadLinksValidator",
  error_codes = {"WLS-LNK-001"},

  validate = function(story)
    local errors = {}
    local passages = {}

    -- Build passage set
    for _, passage in ipairs(story.passages or {}) do
      passages[passage.name:lower()] = true
    end

    -- Add special targets
    for target in pairs(SPECIAL_TARGETS) do
      passages[target:lower()] = true
    end

    -- Check all links
    for _, passage in ipairs(story.passages or {}) do
      -- Check choices
      for _, choice in ipairs(passage.choices or {}) do
        if choice.target and not passages[choice.target:lower()] then
          table.insert(errors, create_error(
            "WLS-LNK-001",
            { passage = passage.name, line = choice.line },
            choice.target
          ))
        end
      end

      -- Check redirects
      for _, link in ipairs(passage.links or {}) do
        if link.target and not passages[link.target:lower()] then
          table.insert(errors, create_error(
            "WLS-LNK-001",
            { passage = passage.name, line = link.line },
            link.target
          ))
        end
      end
    end

    return errors
  end
}

-- WLS-LNK-002: Self links
M.SelfLinkValidator = {
  name = "SelfLinkValidator",
  error_codes = {"WLS-LNK-002"},

  validate = function(story)
    local errors = {}

    for _, passage in ipairs(story.passages or {}) do
      local name_lower = passage.name:lower()

      for _, choice in ipairs(passage.choices or {}) do
        if choice.target and choice.target:lower() == name_lower then
          table.insert(errors, create_error(
            "WLS-LNK-002",
            { passage = passage.name, line = choice.line },
            passage.name
          ))
        end
      end

      for _, link in ipairs(passage.links or {}) do
        if link.target and link.target:lower() == name_lower then
          table.insert(errors, create_error(
            "WLS-LNK-002",
            { passage = passage.name, line = link.line },
            passage.name
          ))
        end
      end
    end

    return errors
  end
}

-- WLS-LNK-003: Special target case
M.SpecialTargetCaseValidator = {
  name = "SpecialTargetCaseValidator",
  error_codes = {"WLS-LNK-003"},

  validate = function(story)
    local errors = {}

    for _, passage in ipairs(story.passages or {}) do
      local check_target = function(target, line)
        if not target then return end
        local upper = target:upper()
        if SPECIAL_TARGETS[upper] and target ~= upper then
          table.insert(errors, create_error(
            "WLS-LNK-003",
            { passage = passage.name, line = line },
            target, upper
          ))
        end
      end

      for _, choice in ipairs(passage.choices or {}) do
        check_target(choice.target, choice.line)
      end

      for _, link in ipairs(passage.links or {}) do
        check_target(link.target, link.line)
      end
    end

    return errors
  end
}

return M

2. Create spec/validators/links_spec.lua with tests.

3. Register in init.lua.
```

## Expected Output
~120 lines validators + ~80 lines tests.

## Verification
```bash
cd ~/code/github.com/writewhisker/whisker-core

busted spec/validators/links_spec.lua
```

## Next Stage
1.18-lua-flow-validators.md
