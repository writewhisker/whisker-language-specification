# Stage 1.10: TypeScript - Dead End Validator

## Objective
Implement the DeadEndValidator for TypeScript.

## Files to Create
- `packages/story-validation/src/validators/DeadEndValidator.ts`
- `packages/story-validation/src/validators/DeadEndValidator.test.ts`

## Prompt

```
Create the DeadEndValidator in whisker-editor-web:

1. Create validator at:
/Users/jims/code/github.com/writewhisker/whisker-editor-web/packages/story-validation/src/validators/DeadEndValidator.ts

import type { Story, Passage } from '@writewhisker/story-models';
import type { StoryValidator, WLSValidationError } from '../types';
import { createValidationError } from '../types';

const TERMINAL_TARGETS = ['END', 'BACK', 'RETURN'];

export class DeadEndValidator implements StoryValidator {
  name = 'DeadEndValidator';
  errorCodes = ['WLS-FLW-001'];

  validate(story: Story): WLSValidationError[] {
    const errors: WLSValidationError[] = [];

    for (const passage of story.passages) {
      if (this.isDeadEnd(passage)) {
        errors.push(createValidationError(
          'WLS-FLW-001',
          [passage.name],
          { passage: passage.name, line: passage.line }
        ));
      }
    }

    return errors;
  }

  private isDeadEnd(passage: Passage): boolean {
    // Has choices -> not dead end
    if (passage.choices && passage.choices.length > 0) {
      return false;
    }

    // Has redirect -> not dead end
    if (passage.links && passage.links.length > 0) {
      return false;
    }

    // Has terminal link in content -> not dead end
    if (this.hasTerminalContent(passage)) {
      return false;
    }

    // Special passages are allowed to be dead ends
    if (TERMINAL_TARGETS.includes(passage.name.toUpperCase())) {
      return false;
    }

    return true;
  }

  private hasTerminalContent(passage: Passage): boolean {
    // Check if passage ends with -> END or similar
    const content = passage.content ?? '';
    const terminalPattern = /->\\s*(END|BACK|RETURN)\\s*$/i;
    return terminalPattern.test(content);
  }
}

2. Create test file at:
/Users/jims/code/github.com/writewhisker/whisker-editor-web/packages/story-validation/src/validators/DeadEndValidator.test.ts

import { describe, it, expect } from 'vitest';
import { DeadEndValidator } from './DeadEndValidator';
import { parse } from '@writewhisker/parser';

describe('DeadEndValidator', () => {
  const validator = new DeadEndValidator();

  it('passes when passage has choices', () => {
    const story = parse(`
:: Start
What do you do?
+ [Option A] -> A
+ [Option B] -> B

:: A
Content A

:: B
Content B
`);
    const errors = validator.validate(story);
    // A and B are dead ends
    expect(errors).toHaveLength(2);
  });

  it('passes when passage has redirect', () => {
    const story = parse(`
:: Start
-> Next

:: Next
-> END
`);
    const errors = validator.validate(story);
    expect(errors).toHaveLength(0);
  });

  it('detects dead end passage', () => {
    const story = parse(`
:: Start
+ [Go] -> DeadEnd

:: DeadEnd
This passage goes nowhere.
`);
    const errors = validator.validate(story);
    expect(errors).toHaveLength(1);
    expect(errors[0].code).toBe('WLS-FLW-001');
    expect(errors[0].location?.passage).toBe('DeadEnd');
  });

  it('allows END as dead end', () => {
    const story = parse(`
:: Start
+ [Finish] -> END

:: END
The end.
`);
    const errors = validator.validate(story);
    expect(errors).toHaveLength(0);
  });
});

3. Register in validators/index.ts.
```

## Expected Output
~70 lines validator + ~70 lines tests.

## Verification
```bash
cd ~/code/github.com/writewhisker/whisker-editor-web

pnpm --filter @writewhisker/story-validation test -- --run DeadEndValidator
```

## Next Stage
1.11-ts-cycle-detector.md
