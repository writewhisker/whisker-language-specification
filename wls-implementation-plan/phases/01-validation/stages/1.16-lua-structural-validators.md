# Stage 1.16: Lua - Structural Validators

## Objective
Implement structure validators for Lua (STR codes).

## Files to Create
- `lib/whisker/validators/structural.lua`
- `spec/validators/structural_spec.lua`

## Prompt

```
Create structural validators in whisker-core:

1. Create lib/whisker/validators/structural.lua:

local error_codes = require("whisker.validators.error_codes")
local create_error = error_codes.create_error

local M = {}

-- WLS-STR-001: Missing Start passage
M.MissingStartPassageValidator = {
  name = "MissingStartPassageValidator",
  error_codes = {"WLS-STR-001"},

  validate = function(story)
    local errors = {}
    local has_start = false

    for _, passage in ipairs(story.passages or {}) do
      if passage.name:lower() == "start" then
        has_start = true
        break
      end
    end

    if not has_start then
      table.insert(errors, create_error("WLS-STR-001", {}))
    end

    return errors
  end
}

-- WLS-STR-003: Duplicate passages
M.DuplicatePassagesValidator = {
  name = "DuplicatePassagesValidator",
  error_codes = {"WLS-STR-003"},

  validate = function(story)
    local errors = {}
    local seen = {}

    for _, passage in ipairs(story.passages or {}) do
      local normalized = passage.name:lower()
      if seen[normalized] then
        table.insert(errors, create_error(
          "WLS-STR-003",
          { passage = passage.name, line = passage.line },
          passage.name
        ))
      else
        seen[normalized] = passage.line or 0
      end
    end

    return errors
  end
}

-- WLS-STR-004: Empty passages
M.EmptyPassagesValidator = {
  name = "EmptyPassagesValidator",
  error_codes = {"WLS-STR-004"},

  validate = function(story)
    local errors = {}

    for _, passage in ipairs(story.passages or {}) do
      local content = passage.content or ""
      local has_choices = passage.choices and #passage.choices > 0
      local has_links = passage.links and #passage.links > 0

      if content:match("^%s*$") and not has_choices and not has_links then
        table.insert(errors, create_error(
          "WLS-STR-004",
          { passage = passage.name },
          passage.name
        ))
      end
    end

    return errors
  end
}

-- WLS-STR-002: Unreachable passages
M.UnreachablePassagesValidator = {
  name = "UnreachablePassagesValidator",
  error_codes = {"WLS-STR-002"},

  validate = function(story)
    local errors = {}
    local reachable = {}
    local all_passages = {}

    -- Build passage map
    for _, passage in ipairs(story.passages or {}) do
      all_passages[passage.name:lower()] = passage
    end

    -- BFS from Start
    local queue = {"start"}
    while #queue > 0 do
      local current = table.remove(queue, 1)
      if not reachable[current] then
        reachable[current] = true
        local passage = all_passages[current]
        if passage then
          -- Add choice targets
          for _, choice in ipairs(passage.choices or {}) do
            if choice.target then
              table.insert(queue, choice.target:lower())
            end
          end
          -- Add link targets
          for _, link in ipairs(passage.links or {}) do
            if link.target then
              table.insert(queue, link.target:lower())
            end
          end
        end
      end
    end

    -- Find unreachable
    for name, passage in pairs(all_passages) do
      if not reachable[name] then
        table.insert(errors, create_error(
          "WLS-STR-002",
          { passage = passage.name },
          passage.name
        ))
      end
    end

    return errors
  end
}

return M

2. Create spec/validators/structural_spec.lua with tests for each validator.

3. Register validators in init.lua by requiring and registering each.
```

## Expected Output
~150 lines validators + ~100 lines tests.

## Verification
```bash
cd ~/code/github.com/writewhisker/whisker-core

busted spec/validators/structural_spec.lua
```

## Next Stage
1.17-lua-link-validators.md
