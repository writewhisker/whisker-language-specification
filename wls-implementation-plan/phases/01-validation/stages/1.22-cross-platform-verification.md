# Stage 1.22: Cross-Platform Verification

## Objective
Verify validation behavior is identical across TypeScript and Lua implementations.

## Files to Create/Modify
- `phase-4-validation/tools/run-validation-corpus.ts`
- `phase-4-validation/tools/run-validation-corpus.lua`

## Prompt

```
Create cross-platform verification tools:

1. Create phase-4-validation/tools/run-validation-corpus.ts:

#!/usr/bin/env npx tsx

import * as fs from 'fs';
import * as path from 'path';
import * as yaml from 'yaml';
import { parse } from '@writewhisker/parser';
import { createDefaultValidator } from '@writewhisker/story-validation';

interface TestCase {
  name: string;
  description?: string;
  input: string;
  expected: {
    valid?: boolean;
    errors?: Array<{ code: string; severity?: string; location?: any }>;
    warnings?: Array<{ code: string; location?: any }>;
    info?: Array<{ code: string; location?: any }>;
  };
}

const corpusDir = path.join(__dirname, '../test-corpus/validation');
const validator = createDefaultValidator();
let passed = 0;
let failed = 0;

function runTest(test: TestCase): boolean {
  try {
    const story = parse(test.input);
    const result = validator.validate(story);

    // Check valid flag
    if (test.expected.valid !== undefined) {
      if (result.valid !== test.expected.valid) {
        console.error(`FAIL: ${test.name} - expected valid=${test.expected.valid}, got ${result.valid}`);
        return false;
      }
    }

    // Check error codes
    if (test.expected.errors) {
      for (const expectedError of test.expected.errors) {
        const found = result.errors.find(e => e.code === expectedError.code);
        if (!found) {
          console.error(`FAIL: ${test.name} - expected error ${expectedError.code} not found`);
          return false;
        }
      }
    }

    // Check warnings
    if (test.expected.warnings) {
      for (const expected of test.expected.warnings) {
        const found = result.warnings.find(e => e.code === expected.code);
        if (!found) {
          console.error(`FAIL: ${test.name} - expected warning ${expected.code} not found`);
          return false;
        }
      }
    }

    console.log(`PASS: ${test.name}`);
    return true;
  } catch (err) {
    console.error(`FAIL: ${test.name} - ${err}`);
    return false;
  }
}

// Run all tests
const files = fs.readdirSync(corpusDir).filter(f => f.endsWith('.yaml'));
for (const file of files) {
  const content = fs.readFileSync(path.join(corpusDir, file), 'utf-8');
  const tests: TestCase[] = yaml.parse(content);

  console.log(`\nRunning ${file}:`);
  for (const test of tests) {
    if (runTest(test)) {
      passed++;
    } else {
      failed++;
    }
  }
}

console.log(`\n=== Results: ${passed} passed, ${failed} failed ===`);
process.exit(failed > 0 ? 1 : 0);

2. Create similar run-validation-corpus.lua for Lua testing.

3. Create comparison script that runs both and compares output:

#!/bin/bash
# phase-4-validation/tools/compare-validation.sh

echo "Running TypeScript validation corpus..."
npx tsx tools/run-validation-corpus.ts > /tmp/ts-validation.txt 2>&1
TS_EXIT=$?

echo "Running Lua validation corpus..."
lua tools/run-validation-corpus.lua > /tmp/lua-validation.txt 2>&1
LUA_EXIT=$?

echo ""
echo "=== Comparison ==="
if [ $TS_EXIT -eq 0 ] && [ $LUA_EXIT -eq 0 ]; then
  echo "Both platforms pass all tests!"
else
  echo "TypeScript exit: $TS_EXIT"
  echo "Lua exit: $LUA_EXIT"
  diff /tmp/ts-validation.txt /tmp/lua-validation.txt
fi
```

## Expected Output
~150 lines TypeScript + ~150 lines Lua + ~30 lines shell script.

## Verification
```bash
cd ~/code/github.com/whisker-language-specification-1.0/phase-4-validation

# Run TypeScript tests
npx tsx tools/run-validation-corpus.ts

# Run Lua tests
lua tools/run-validation-corpus.lua

# Compare both
./tools/compare-validation.sh
# Expected: Both platforms pass all tests!
```

## Phase 1 Complete
This completes Phase 1: Validation. All validators are implemented, tested, and verified across platforms.
