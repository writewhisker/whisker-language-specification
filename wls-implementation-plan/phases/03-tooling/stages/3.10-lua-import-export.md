# Stage 3.10: Lua Import/Export

## Objective
Implement import/export in Lua for cross-platform parity.

## Files to Create
- `lib/whisker/import/init.lua`
- `lib/whisker/import/twine.lua`
- `lib/whisker/export/init.lua`
- `lib/whisker/export/html.lua`

## Prompt

```
Create import/export modules in whisker-core:

1. Create lib/whisker/import/init.lua:

local M = {}

local importers = {}

function M.register(importer)
  importers[importer.name] = importer
end

function M.detect(content)
  for _, importer in pairs(importers) do
    if importer.detect(content) then
      return importer
    end
  end
  return nil
end

function M.import(content, format)
  local importer
  if format then
    importer = importers[format]
    if not importer then
      error("Unknown format: " .. format)
    end
  else
    importer = M.detect(content)
    if not importer then
      error("Could not detect format")
    end
  end
  return importer.import(content)
end

return M

2. Create lib/whisker/import/twine.lua:

local M = {}

M.name = "twine"
M.extensions = {".html", ".tw"}

function M.detect(content)
  return content:find("<tw%-storydata") ~= nil
end

function M.import(content)
  local story = {
    passages = {},
    warnings = {}
  }

  -- Parse tw-storydata attributes
  local storydata = content:match("<tw%-storydata([^>]*)>")
  if storydata then
    story.title = storydata:match('name="([^"]*)"')
    story.ifid = storydata:match('ifid="([^"]*)"')
  end

  -- Parse passages
  for attrs, pcontent in content:gmatch("<tw%-passagedata([^>]*)>(.-)</tw%-passagedata>") do
    local name = attrs:match('name="([^"]*)"')
    local converted = M.convert_content(pcontent, story.warnings)

    table.insert(story.passages, {
      name = name,
      content = converted
    })
  end

  return story
end

function M.convert_content(content, warnings)
  -- Decode HTML entities
  content = content:gsub("&lt;", "<")
  content = content:gsub("&gt;", ">")
  content = content:gsub("&amp;", "&")
  content = content:gsub("&quot;", '"')

  -- Convert links [[text|target]] -> + [text] -> target
  content = content:gsub("%[%[([^%]|]+)|([^%]]+)%]%]", "+ [%1] -> %2")
  content = content:gsub("%[%[([^%]|]+)%]%]", "+ [%1] -> %1")

  -- Convert variables (Harlowe style)
  content = content:gsub("%(set:%s*%$(%w+)%s+to%s+(.-)%)", "{do $%1 = %2}")

  -- Convert conditionals
  content = content:gsub("%(if:%s*(.-)%)%[(.-)%]", "{%1}\\n%2\\n{/}")

  return content
end

return M

3. Create lib/whisker/export/html.lua:

local M = {}

M.name = "html"
M.extension = ".html"

local TEMPLATE = [[
<!DOCTYPE html>
<html><head><title>%s</title></head>
<body>
<div id="story"></div>
<script>
const STORY = %s;
// Minimal player
</script>
</body></html>
]]

function M.export(story, options)
  local title = options and options.title or story.title or "Story"
  local json = M.story_to_json(story)
  return string.format(TEMPLATE, title, json)
end

function M.story_to_json(story)
  -- Simple JSON serialization
  local parts = {"{\"passages\":["}
  for i, p in ipairs(story.passages) do
    if i > 1 then table.insert(parts, ",") end
    table.insert(parts, string.format(
      '{\"name\":\"%s\",\"content\":\"%s\"}',
      p.name:gsub('"', '\\"'),
      p.content:gsub('"', '\\"'):gsub("\\n", "\\\\n")
    ))
  end
  table.insert(parts, "]}")
  return table.concat(parts)
end

return M

4. Create tests for both modules.
```

## Expected Output
~200 lines across 4 files.

## Verification
```bash
cd ~/code/github.com/writewhisker/whisker-core

busted spec/import/
busted spec/export/
```

## Phase 3 Complete
This completes the core tooling for import/export.
