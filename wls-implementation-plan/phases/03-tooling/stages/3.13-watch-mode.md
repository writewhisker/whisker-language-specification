# Stage 3.13: Watch Mode Implementation

## Objective
Implement file watching for development workflow.

## Dependencies
- Stage 3.09 (CLI commands)

## Parallelization
- Can run in parallel with 3.11, 3.12, 3.16

## Files to Modify
- `packages/cli-build/src/index.ts`
- `packages/cli-build/src/watch.ts` (create)

## Prompt

```
Implement watch mode for CLI:

1. Create packages/cli-build/src/watch.ts:

import * as chokidar from 'chokidar';
import * as path from 'path';
import { build, BuildOptions, BuildResult } from './build';
import { debounce } from './utils';

interface WatchOptions extends BuildOptions {
  /** Debounce delay in ms */
  debounce?: number;
  /** Callback on rebuild */
  onRebuild?: (result: BuildResult) => void;
  /** Callback on error */
  onError?: (error: Error) => void;
}

export class Watcher {
  private watcher: chokidar.FSWatcher | null = null;
  private building = false;

  constructor(private options: WatchOptions) {}

  async start(): Promise<void> {
    const patterns = [
      '**/*.ws',
      '**/*.wls',
      '**/*.whisker',
    ];

    // Initial build
    console.log('Starting initial build...');
    try {
      const result = await build(this.options);
      this.options.onRebuild?.(result);
      console.log(`Built ${result.passageCount} passages`);
    } catch (error) {
      this.options.onError?.(error as Error);
    }

    // Start watching
    console.log('Watching for changes...');
    this.watcher = chokidar.watch(patterns, {
      ignored: ['**/node_modules/**', '**/dist/**', '**/.git/**'],
      persistent: true,
      ignoreInitial: true,
    });

    const rebuild = debounce(async (changedPath: string) => {
      if (this.building) return;
      this.building = true;

      console.log(`\nFile changed: ${path.relative(process.cwd(), changedPath)}`);
      console.log('Rebuilding...');

      try {
        const start = Date.now();
        const result = await build(this.options);
        const duration = Date.now() - start;

        console.log(`✓ Built in ${duration}ms`);
        this.options.onRebuild?.(result);
      } catch (error) {
        console.error(`✗ Build failed: ${(error as Error).message}`);
        this.options.onError?.(error as Error);
      } finally {
        this.building = false;
      }
    }, this.options.debounce ?? 100);

    this.watcher
      .on('change', rebuild)
      .on('add', rebuild)
      .on('unlink', rebuild);
  }

  async stop(): Promise<void> {
    await this.watcher?.close();
    this.watcher = null;
  }
}

export async function watch(options: WatchOptions): Promise<Watcher> {
  const watcher = new Watcher(options);
  await watcher.start();
  return watcher;
}

2. Update CLI build command to support --watch:

import { Command } from 'commander';
import { build } from './build';
import { watch } from './watch';

export function createBuildCommand(): Command {
  return new Command('build')
    .description('Build WLS story')
    .argument('[input]', 'Input file or directory', '.')
    .option('-o, --output <path>', 'Output directory', 'dist')
    .option('-f, --format <format>', 'Output format', 'html')
    .option('-w, --watch', 'Watch for changes')
    .option('--minify', 'Minify output')
    .action(async (input, options) => {
      if (options.watch) {
        console.log('Starting watch mode...');
        const watcher = await watch({
          input,
          output: options.output,
          format: options.format,
          minify: options.minify,
          onRebuild: (result) => {
            // Optional: trigger browser reload
          },
          onError: (error) => {
            // Keep watching despite errors
          },
        });

        // Handle graceful shutdown
        process.on('SIGINT', async () => {
          console.log('\nStopping watch...');
          await watcher.stop();
          process.exit(0);
        });
      } else {
        // Single build
        const result = await build({
          input,
          output: options.output,
          format: options.format,
          minify: options.minify,
        });
        console.log(`Built ${result.passageCount} passages to ${options.output}`);
      }
    });
}

3. Add live reload support (optional enhancement):
   - Start local dev server
   - Inject live reload script into HTML
   - WebSocket connection for instant refresh

4. Add dependency tracking:
   - Track @import dependencies
   - Rebuild when imported files change
   - Build dependency graph
```

## Expected Output
~150 lines watch implementation + ~50 lines CLI updates.

## Verification
```bash
# Start watch mode
whisker build --watch

# In another terminal, modify a .ws file
# Verify rebuild triggers automatically
```

## Success Criteria
- [ ] `whisker build --watch` starts watcher
- [ ] File changes trigger rebuild
- [ ] Debounce prevents rapid rebuilds
- [ ] Errors don't crash watcher
- [ ] Graceful shutdown on Ctrl+C
- [ ] Clear console output showing rebuild status

## Next Stage
3.14-ifdb-publisher.md
