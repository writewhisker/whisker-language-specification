# Stage 3.01: Import Framework

## Objective
Create the extensible import framework for both platforms.

## Files to Create
- `packages/import/src/types.ts`
- `packages/import/src/ImportManager.ts`
- `packages/import/src/index.ts`
- `packages/import/package.json`

## Prompt

```
Create the import package in whisker-editor-web:

1. Create packages/import/package.json:

{
  "name": "@writewhisker/import",
  "version": "1.0.0",
  "main": "dist/index.js",
  "types": "dist/index.d.ts",
  "scripts": {
    "build": "vite build",
    "test": "vitest"
  },
  "dependencies": {
    "@writewhisker/story-models": "workspace:*",
    "@writewhisker/parser": "workspace:*"
  }
}

2. Create packages/import/src/types.ts:

import type { Story } from '@writewhisker/story-models';

export interface ImportResult {
  story: Story;
  warnings: ImportWarning[];
  metadata: ImportMetadata;
}

export interface ImportWarning {
  type: 'unsupported_feature' | 'conversion_note' | 'data_loss';
  message: string;
  location?: { line?: number; passage?: string };
  original?: string;
}

export interface ImportMetadata {
  sourceFormat: string;
  sourceVersion?: string;
  passageCount: number;
  importedAt: string;
}

export interface Importer {
  name: string;
  extensions: string[];
  mimeTypes: string[];

  /** Check if content is this format */
  detect(content: string): boolean;

  /** Import content to WLS Story */
  import(content: string, options?: ImportOptions): Promise<ImportResult>;
}

export interface ImportOptions {
  preserveMetadata?: boolean;
  strictMode?: boolean;
  encoding?: string;
}

3. Create packages/import/src/ImportManager.ts:

import type { Importer, ImportResult, ImportOptions } from './types';

export class ImportManager {
  private importers: Map<string, Importer> = new Map();

  register(importer: Importer): void {
    this.importers.set(importer.name, importer);
  }

  getImporter(name: string): Importer | undefined {
    return this.importers.get(name);
  }

  detectFormat(content: string): Importer | undefined {
    for (const importer of this.importers.values()) {
      if (importer.detect(content)) {
        return importer;
      }
    }
    return undefined;
  }

  async import(
    content: string,
    format?: string,
    options?: ImportOptions
  ): Promise<ImportResult> {
    let importer: Importer | undefined;

    if (format) {
      importer = this.importers.get(format);
      if (!importer) {
        throw new Error(\`Unknown import format: \${format}\`);
      }
    } else {
      importer = this.detectFormat(content);
      if (!importer) {
        throw new Error('Could not detect story format');
      }
    }

    return importer.import(content, options);
  }

  listFormats(): string[] {
    return Array.from(this.importers.keys());
  }
}

4. Create packages/import/src/index.ts:

export * from './types';
export { ImportManager } from './ImportManager';

// Will add specific importers in later stages
```

## Expected Output
~150 lines across 4 files.

## Verification
```bash
cd ~/code/github.com/writewhisker/whisker-editor-web

pnpm --filter @writewhisker/import build
pnpm --filter @writewhisker/import typecheck
```

## Next Stage
3.02-twine-archive-parser.md
