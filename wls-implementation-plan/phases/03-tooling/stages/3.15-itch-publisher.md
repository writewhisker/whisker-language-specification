# Stage 3.15: itch.io Publisher

## Objective
Implement publishing to itch.io platform.

## Dependencies
- Stage 3.08 (PWA exporter)
- Stage 3.09 (CLI commands)

## Parallelization
- Can run in parallel with 3.14, 3.17

## Files to Create
- `packages/cli-deploy/src/publishers/itch.ts`
- `packages/cli-deploy/src/publishers/itch.test.ts`

## Prompt

```
Create itch.io publisher:

1. itch.io requirements:
   - Butler CLI tool for uploads
   - Project name (user/game format)
   - Channel for versioning
   - ZIP file with HTML5 game

2. Create packages/cli-deploy/src/publishers/itch.ts:

import type { Publisher, PublishOptions, PublishResult } from '../types';
import type { Story } from '@writewhisker/story-models';
import { exec } from 'child_process';
import { promisify } from 'util';
import * as fs from 'fs';
import * as path from 'path';
import * as archiver from 'archiver';

const execAsync = promisify(exec);

interface ItchConfig {
  /** itch.io project (user/game) */
  project: string;
  /** Channel name (e.g., html5, windows, mac) */
  channel?: string;
  /** Version string */
  version?: string;
}

export class ItchPublisher implements Publisher {
  name = 'itch';

  async publish(
    story: Story,
    buildDir: string,
    options: PublishOptions & ItchConfig
  ): Promise<PublishResult> {
    // Verify butler is installed
    try {
      await execAsync('butler --version');
    } catch {
      throw new Error(
        'Butler CLI not found. Install from https://itch.io/docs/butler/'
      );
    }

    // Verify build directory exists
    if (!fs.existsSync(buildDir) || !fs.statSync(buildDir).isDirectory()) {
      throw new Error(`Build directory not found: ${buildDir}`);
    }

    // Create ZIP if directory
    const zipPath = await this.createZip(buildDir, story.metadata.title);

    // Determine channel
    const channel = options.channel || 'html5';

    // Build butler command
    const project = options.project;
    const version = options.version || this.generateVersion();

    const cmd = [
      'butler push',
      `"${zipPath}"`,
      `${project}:${channel}`,
      `--userversion=${version}`,
    ].join(' ');

    console.log(`Publishing to ${project}:${channel}...`);

    try {
      const { stdout, stderr } = await execAsync(cmd);

      if (stderr && !stderr.includes('pushing')) {
        console.warn(stderr);
      }

      // Clean up ZIP
      fs.unlinkSync(zipPath);

      return {
        success: true,
        url: `https://${project.split('/')[0]}.itch.io/${project.split('/')[1]}`,
        metadata: {
          project,
          channel,
          version,
        },
      };
    } catch (error) {
      throw new Error(`Butler push failed: ${(error as Error).message}`);
    }
  }

  private async createZip(dir: string, title: string): Promise<string> {
    const zipPath = path.join(
      path.dirname(dir),
      `${title.replace(/[^a-z0-9]/gi, '_')}.zip`
    );

    return new Promise((resolve, reject) => {
      const output = fs.createWriteStream(zipPath);
      const archive = archiver('zip', { zlib: { level: 9 } });

      output.on('close', () => resolve(zipPath));
      archive.on('error', reject);

      archive.pipe(output);
      archive.directory(dir, false);
      archive.finalize();
    });
  }

  private generateVersion(): string {
    const now = new Date();
    return [
      now.getFullYear(),
      String(now.getMonth() + 1).padStart(2, '0'),
      String(now.getDate()).padStart(2, '0'),
      String(now.getHours()).padStart(2, '0'),
      String(now.getMinutes()).padStart(2, '0'),
    ].join('.');
  }
}

3. Add CLI command:

whisker publish --platform=itch [options]
  --project    itch.io project (user/game)
  --channel    Release channel (default: html5)
  --version    Version string (auto-generated if not provided)

4. Integration with build pipeline:

# Build PWA and publish in one command
whisker build --format=pwa --output=dist && \
whisker publish --platform=itch --project=user/game

5. Add .whiskerrc config support:

{
  "publish": {
    "itch": {
      "project": "username/my-story",
      "channel": "html5"
    }
  }
}
```

## Expected Output
~120 lines publisher + ~60 lines tests.

## Verification
```bash
# Dry run
whisker publish --platform=itch --project=test/game --dry-run

# Actual publish (requires butler login)
butler login
whisker publish --platform=itch --project=user/game
```

## Success Criteria
- [ ] Butler availability check works
- [ ] ZIP creation works correctly
- [ ] Butler push succeeds
- [ ] Version auto-generation works
- [ ] Config file support works
- [ ] Clear error messages

## Next Stage
3.16-vcs-diff.md
