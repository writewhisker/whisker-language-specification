# Stage 3.09: CLI Import/Export Commands

## Objective
Add import and export commands to CLI.

## Files to Create/Modify
- `packages/cli/src/commands/import.ts`
- `packages/cli/src/commands/export.ts`

## Prompt

```
Create CLI commands for import/export:

1. Create packages/cli/src/commands/import.ts:

import { Command } from 'commander';
import * as fs from 'fs';
import * as path from 'path';
import { ImportManager, TwineImporter } from '@writewhisker/import';

export function createImportCommand(): Command {
  const cmd = new Command('import')
    .description('Import story from another format')
    .argument('<file>', 'Input file to import')
    .option('-f, --from <format>', 'Source format (auto-detected if not specified)')
    .option('-o, --output <file>', 'Output WLS file')
    .option('--strict', 'Fail on conversion warnings')
    .action(async (file, options) => {
      const manager = new ImportManager();
      manager.register(new TwineImporter());

      // Read input
      const inputPath = path.resolve(file);
      if (!fs.existsSync(inputPath)) {
        console.error(\`File not found: \${inputPath}\`);
        process.exit(1);
      }
      const content = fs.readFileSync(inputPath, 'utf-8');

      // Import
      try {
        const result = await manager.import(content, options.from);

        // Show warnings
        if (result.warnings.length > 0) {
          console.log(\`\\n\${result.warnings.length} warnings:\`);
          for (const warning of result.warnings) {
            console.log(\`  - \${warning.message}\`);
          }
          if (options.strict) {
            process.exit(1);
          }
        }

        // Generate output
        const wlsContent = this.storyToWls(result.story);

        // Write output
        const outputPath = options.output ||
          inputPath.replace(/\\.[^.]+$/, '.ws');
        fs.writeFileSync(outputPath, wlsContent);

        console.log(\`\\nImported \${result.metadata.passageCount} passages\`);
        console.log(\`Written to: \${outputPath}\`);
      } catch (err) {
        console.error(\`Import failed: \${err.message}\`);
        process.exit(1);
      }
    });

  return cmd;
}

2. Create packages/cli/src/commands/export.ts:

import { Command } from 'commander';
import * as fs from 'fs';
import * as path from 'path';
import { parse } from '@writewhisker/parser';
import { ExportManager, HTMLExporter, PWAExporter } from '@writewhisker/export';

export function createExportCommand(): Command {
  const cmd = new Command('export')
    .description('Export story to another format')
    .argument('<file>', 'WLS file to export')
    .option('-t, --to <format>', 'Target format', 'html')
    .option('-o, --output <path>', 'Output file or directory')
    .option('--title <title>', 'Story title')
    .option('--minify', 'Minify output')
    .option('--theme <theme>', 'Theme name or CSS file')
    .action(async (file, options) => {
      const manager = new ExportManager();
      manager.register(new HTMLExporter());
      manager.register(new PWAExporter());

      // Read and parse input
      const inputPath = path.resolve(file);
      if (!fs.existsSync(inputPath)) {
        console.error(\`File not found: \${inputPath}\`);
        process.exit(1);
      }
      const content = fs.readFileSync(inputPath, 'utf-8');
      const story = parse(content);

      // Export
      try {
        const result = await manager.export(story, options.to, {
          title: options.title,
          minify: options.minify,
          customCss: options.theme && fs.existsSync(options.theme)
            ? fs.readFileSync(options.theme, 'utf-8')
            : undefined
        });

        // Write output
        const outputPath = options.output ||
          inputPath.replace(/\\.ws$/, result.filename);

        if (result.additionalFiles) {
          // Create directory for multiple files
          const outDir = path.dirname(outputPath);
          fs.mkdirSync(outDir, { recursive: true });
          fs.writeFileSync(outputPath, result.content);
          for (const file of result.additionalFiles) {
            fs.writeFileSync(path.join(outDir, file.path), file.content);
          }
        } else {
          fs.writeFileSync(outputPath, result.content);
        }

        console.log(\`Exported to: \${outputPath}\`);
      } catch (err) {
        console.error(\`Export failed: \${err.message}\`);
        process.exit(1);
      }
    });

  return cmd;
}

3. Register commands in main CLI entry point.
```

## Expected Output
~150 lines across two command files.

## Verification
```bash
# Test import
whisker import test.html --from=twine -o test.ws

# Test export
whisker export test.ws --to=html -o test.html
```

## Next Stage
3.10-lua-import-export.md
