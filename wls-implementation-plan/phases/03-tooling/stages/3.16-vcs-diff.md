# Stage 3.16: VCS Semantic Diff

## Objective
Create story-aware diff tool for WLS files.

## Dependencies
- Stage 3.09 (CLI framework)

## Parallelization
- Can run in parallel with 3.11, 3.12, 3.13

## Files to Create
- `packages/cli/src/commands/diff.ts`
- `packages/vcs/src/diff.ts`
- `packages/vcs/src/diff.test.ts`

## Prompt

```
Create semantic diff for WLS files:

1. Problem: Standard text diff is noisy for IF files
   - Reordering passages shows as complete rewrite
   - Whitespace changes obscure real changes
   - Variable renames hard to track

2. Create packages/vcs/src/diff.ts:

import { parse } from '@writewhisker/parser';
import type { Story, Passage, Variable } from '@writewhisker/story-models';

interface DiffResult {
  metadata: MetadataDiff;
  passages: PassageDiff[];
  variables: VariableDiff[];
  summary: DiffSummary;
}

interface PassageDiff {
  type: 'added' | 'removed' | 'modified' | 'moved';
  passageId: string;
  title: string;
  oldIndex?: number;
  newIndex?: number;
  changes?: ContentChange[];
}

interface ContentChange {
  type: 'text' | 'choice' | 'conditional' | 'variable';
  action: 'added' | 'removed' | 'modified';
  line: number;
  description: string;
}

interface VariableDiff {
  type: 'added' | 'removed' | 'modified' | 'renamed';
  name: string;
  oldName?: string;
  oldValue?: any;
  newValue?: any;
}

interface DiffSummary {
  passagesAdded: number;
  passagesRemoved: number;
  passagesModified: number;
  passagesMoved: number;
  variablesChanged: number;
  totalChanges: number;
}

export function diff(oldSource: string, newSource: string): DiffResult {
  const oldStory = parse(oldSource);
  const newStory = parse(newSource);

  return {
    metadata: diffMetadata(oldStory, newStory),
    passages: diffPassages(oldStory, newStory),
    variables: diffVariables(oldStory, newStory),
    summary: computeSummary(...),
  };
}

function diffPassages(oldStory: Story, newStory: Story): PassageDiff[] {
  const diffs: PassageDiff[] = [];

  // Build maps by title (passages are identified by title)
  const oldByTitle = new Map(
    Array.from(oldStory.passages.values()).map((p, i) => [p.title, { passage: p, index: i }])
  );
  const newByTitle = new Map(
    Array.from(newStory.passages.values()).map((p, i) => [p.title, { passage: p, index: i }])
  );

  // Find added passages
  for (const [title, { passage, index }] of newByTitle) {
    if (!oldByTitle.has(title)) {
      diffs.push({
        type: 'added',
        passageId: passage.id,
        title,
        newIndex: index,
      });
    }
  }

  // Find removed passages
  for (const [title, { passage, index }] of oldByTitle) {
    if (!newByTitle.has(title)) {
      diffs.push({
        type: 'removed',
        passageId: passage.id,
        title,
        oldIndex: index,
      });
    }
  }

  // Find modified and moved passages
  for (const [title, { passage: newPassage, index: newIndex }] of newByTitle) {
    const old = oldByTitle.get(title);
    if (old) {
      const contentChanges = diffPassageContent(old.passage, newPassage);
      if (contentChanges.length > 0) {
        diffs.push({
          type: 'modified',
          passageId: newPassage.id,
          title,
          oldIndex: old.index,
          newIndex,
          changes: contentChanges,
        });
      } else if (old.index !== newIndex) {
        diffs.push({
          type: 'moved',
          passageId: newPassage.id,
          title,
          oldIndex: old.index,
          newIndex,
        });
      }
    }
  }

  return diffs;
}

3. Output formats:

   // Human readable
   whisker diff old.ws new.ws

   Passage "Start" modified:
     + Choice added: [Go east]
     ~ Text changed: line 5
     - Variable removed: $oldVar

   Passage "NewRoom" added
   Passage "OldRoom" removed

   Summary: 2 modified, 1 added, 1 removed

   // JSON for tooling
   whisker diff old.ws new.ws --json

   // Patch format
   whisker diff old.ws new.ws --patch

4. Git integration:

   # .gitattributes
   *.ws diff=whisker

   # .gitconfig
   [diff "whisker"]
     textconv = whisker show --normalized
```

## Expected Output
~250 lines diff implementation + ~100 lines tests.

## Verification
```bash
# Create test files
echo ':: Start\nHello' > old.ws
echo ':: Start\nHello World\n:: New\nNew passage' > new.ws

# Run diff
whisker diff old.ws new.ws
```

## Success Criteria
- [ ] Passage add/remove/modify detected
- [ ] Passage reordering detected as "moved"
- [ ] Content changes described semantically
- [ ] Variable changes tracked
- [ ] Human-readable output clear
- [ ] JSON output machine-parseable
- [ ] Git integration works

## Next Stage
3.17-vcs-merge.md
