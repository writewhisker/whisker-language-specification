# Stage 3.11: ChoiceScript Importer

## Objective
Import stories from ChoiceScript format.

## Dependencies
- Stage 3.05 (Import framework complete)

## Parallelization
- Can run in parallel with 3.12, 3.13, 3.16

## Files to Create
- `packages/import/src/formats/ChoiceScriptImporter.ts`
- `packages/import/src/formats/ChoiceScriptImporter.test.ts`

## Prompt

```
Create ChoiceScript importer:

1. ChoiceScript syntax to convert:

   *create gold 100        ->  $gold = 100
   *set gold +50           ->  {do $gold += 50}
   *if (gold > 50)         ->  {$gold > 50}
   *else                   ->  {else}
   *elseif (gold > 25)     ->  {elif $gold > 25}
   *choice                 ->  choices
   #Option text            ->  + [Option text]
   *goto scene_name        ->  -> scene_name
   *goto_scene file        ->  -> file::Start
   *finish                 ->  -> END
   *ending                 ->  -> END

2. Create packages/import/src/formats/ChoiceScriptImporter.ts:

import type { Importer, ImportResult, ImportContext } from '../types';
import type { Story } from '@writewhisker/story-models';

export class ChoiceScriptImporter implements Importer {
  name = 'choicescript';
  extensions = ['.txt'];

  detect(content: string): boolean {
    // ChoiceScript files start with *create or *temp declarations
    return /^\*(?:create|temp|title|author)/m.test(content);
  }

  async import(content: string, context?: ImportContext): Promise<ImportResult> {
    const tracker = new ConversionTracker();
    const lines = content.split('\n');

    // Parse header declarations
    const variables = this.parseDeclarations(lines, tracker);

    // Parse scenes (passages)
    const passages = this.parseScenes(lines, tracker);

    // Build story
    const story = new Story();
    story.metadata.title = this.extractTitle(lines);
    variables.forEach(v => story.variables.set(v.name, v));
    passages.forEach(p => story.passages.set(p.id, p));

    return {
      story,
      metadata: { passageCount: passages.length },
      warnings: tracker.getWarnings(),
      lossReport: tracker.buildLossReport()
    };
  }

  private parseDeclarations(lines: string[], tracker: ConversionTracker): Variable[] {
    const vars: Variable[] = [];
    for (const line of lines) {
      const createMatch = line.match(/^\*create\s+(\w+)\s+(.+)/);
      if (createMatch) {
        vars.push({
          name: createMatch[1],
          initial: this.parseValue(createMatch[2]),
          type: this.inferType(createMatch[2])
        });
      }
    }
    return vars;
  }

  private parseScenes(lines: string[], tracker: ConversionTracker): Passage[] {
    // Split by *label and scene files
    // Convert *choice blocks to WLS choices
    // Convert *if/*else/*elseif to WLS conditionals
    // Handle *goto and *goto_scene
  }

  private convertCondition(csCondition: string): string {
    // Convert ChoiceScript operators to WLS
    // (gold > 50) -> $gold > 50
    // (not(found)) -> not $found
    // (gold > 50) and (has_key) -> $gold > 50 and $has_key
  }

  private convertText(csText: string): string {
    // Convert ${variable} to $variable
    // Convert *if inline to WLS inline conditionals
    // Handle *line_break and *page_break
  }
}

3. Handle ChoiceScript-specific features:

   - *stat_chart -> convert to passage with stats display
   - *input_text -> warn (not supported in WLS 1.0)
   - *rand -> {~| option1 | option2 | ...}
   - *fake_choice -> sticky choices (*)
   - Implicit control flow -> explicit choices/navigation

4. Loss report for unsupported features:
   - *achievement
   - *check_achievements
   - *share_this_game
   - *show_password
   - *input_text
   - *input_number
```

## Expected Output
~300 lines importer + ~150 lines tests.

## Verification
```bash
pnpm --filter @writewhisker/import test -- --run ChoiceScript
```

## Success Criteria
- [ ] *create/*set variables converted
- [ ] *choice blocks converted to WLS choices
- [ ] *if/*else/*elseif conditionals converted
- [ ] *goto/*goto_scene navigation converted
- [ ] Loss report generated for unsupported features
- [ ] Round-trip maintains story logic

## Next Stage
3.12-ink-import-verification.md
