# Stage 3.07: Static HTML Exporter

## Objective
Export stories as self-contained HTML files.

## Files to Create
- `packages/export/src/formats/HTMLExporter.ts`
- `packages/export/src/formats/HTMLExporter.test.ts`
- `packages/export/src/templates/player.html`

## Prompt

```
Create HTML exporter:

1. Create packages/export/src/templates/player.html:

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{TITLE}}</title>
  <style>
    {{STYLES}}
  </style>
</head>
<body>
  <div id="story-container">
    <div id="passage-content"></div>
    <div id="choices-container"></div>
  </div>
  <script>
    const STORY_DATA = {{STORY_JSON}};
    {{PLAYER_RUNTIME}}
  </script>
</body>
</html>

2. Create packages/export/src/formats/HTMLExporter.ts:

import type { Exporter, ExportResult, ExportOptions } from '../types';
import type { Story } from '@writewhisker/story-models';
import playerTemplate from '../templates/player.html?raw';

const DEFAULT_STYLES = \`
  body {
    font-family: Georgia, serif;
    max-width: 600px;
    margin: 2rem auto;
    padding: 1rem;
    line-height: 1.6;
  }
  #passage-content { margin-bottom: 2rem; }
  .choice {
    display: block;
    padding: 0.5rem 1rem;
    margin: 0.5rem 0;
    background: #f0f0f0;
    border: none;
    cursor: pointer;
    text-align: left;
    width: 100%;
  }
  .choice:hover { background: #e0e0e0; }
\`;

const PLAYER_RUNTIME = \`
  // Minimal player runtime
  class StoryPlayer {
    constructor(story) {
      this.story = story;
      this.passages = new Map(story.passages.map(p => [p.name, p]));
      this.variables = {};
      this.current = null;
    }

    start() {
      this.navigateTo('Start');
    }

    navigateTo(name) {
      const passage = this.passages.get(name);
      if (!passage) {
        console.error('Passage not found:', name);
        return;
      }
      this.current = passage;
      this.render();
    }

    render() {
      const contentEl = document.getElementById('passage-content');
      const choicesEl = document.getElementById('choices-container');

      contentEl.innerHTML = this.renderContent(this.current.content);
      choicesEl.innerHTML = '';

      for (const choice of this.current.choices || []) {
        const btn = document.createElement('button');
        btn.className = 'choice';
        btn.textContent = choice.text;
        btn.onclick = () => this.navigateTo(choice.target);
        choicesEl.appendChild(btn);
      }
    }

    renderContent(content) {
      // Simple variable interpolation
      return content.replace(/\\$(\w+)/g, (_, name) => this.variables[name] ?? '');
    }
  }

  const player = new StoryPlayer(STORY_DATA);
  player.start();
\`;

export class HTMLExporter implements Exporter {
  name = 'html';
  extension = '.html';
  mimeType = 'text/html';

  async export(story: Story, options?: ExportOptions): Promise<ExportResult> {
    const title = options?.title || story.title || 'Untitled Story';
    const styles = options?.customCss || DEFAULT_STYLES;

    let html = playerTemplate
      .replace('{{TITLE}}', this.escapeHtml(title))
      .replace('{{STYLES}}', styles)
      .replace('{{STORY_JSON}}', JSON.stringify(story))
      .replace('{{PLAYER_RUNTIME}}', PLAYER_RUNTIME);

    if (options?.minify) {
      html = this.minify(html);
    }

    return {
      content: html,
      filename: \`\${this.sanitizeFilename(title)}.html\`,
      mimeType: this.mimeType
    };
  }

  private escapeHtml(text: string): string {
    return text.replace(/[&<>"']/g, c => ({
      '&': '&amp;', '<': '&lt;', '>': '&gt;',
      '"': '&quot;', "'": '&#39;'
    }[c] || c));
  }

  private sanitizeFilename(name: string): string {
    return name.toLowerCase().replace(/[^a-z0-9]+/g, '-');
  }

  private minify(html: string): string {
    return html.replace(/\s+/g, ' ').replace(/>\s+</g, '><');
  }
}

3. Create tests verifying HTML output is valid and playable.
```

## Expected Output
~150 lines exporter + ~80 lines tests.

## Verification
```bash
pnpm --filter @writewhisker/export test -- --run HTMLExporter
```

## Next Stage
3.08-pwa-exporter.md
