# Stage 3.14: IFDB Publisher

## Objective
Implement publishing to Interactive Fiction Database.

## Dependencies
- Stage 3.07 (HTML exporter)
- Stage 3.09 (CLI commands)

## Parallelization
- Can run in parallel with 3.15, 3.17

## Files to Create
- `packages/cli-deploy/src/publishers/ifdb.ts`
- `packages/cli-deploy/src/publishers/ifdb.test.ts`

## Prompt

```
Create IFDB publisher:

1. IFDB requirements:
   - IFID (Interactive Fiction ID) in Treaty of Babel format
   - Bibliographic metadata (title, author, description)
   - Downloadable story file
   - Cover art (optional)
   - IFDB API access

2. Create packages/cli-deploy/src/publishers/ifdb.ts:

import type { Publisher, PublishOptions, PublishResult } from '../types';
import type { Story } from '@writewhisker/story-models';
import * as fs from 'fs';
import * as path from 'path';

interface IFDBConfig {
  /** IFDB API key (from environment or config) */
  apiKey: string;
  /** TUID if updating existing entry */
  tuid?: string;
}

interface IFDBMetadata {
  title: string;
  author: string;
  description: string;
  ifid: string;
  genre?: string;
  firstPublished?: string;
  language?: string;
  series?: string;
  seriesNumber?: number;
  forgiveness?: 'merciful' | 'polite' | 'tough' | 'nasty' | 'cruel';
}

export class IFDBPublisher implements Publisher {
  name = 'ifdb';

  async publish(
    story: Story,
    storyFile: Buffer | string,
    options: PublishOptions & IFDBConfig
  ): Promise<PublishResult> {
    // Validate IFID
    const ifid = story.metadata.ifid;
    if (!ifid || !this.isValidIFID(ifid)) {
      throw new Error('Valid IFID required for IFDB publishing');
    }

    // Prepare metadata
    const metadata: IFDBMetadata = {
      title: story.metadata.title || 'Untitled',
      author: story.metadata.author || 'Anonymous',
      description: story.metadata.description || '',
      ifid,
      genre: story.metadata.genre,
      firstPublished: new Date().toISOString().split('T')[0],
      language: story.metadata.language || 'en',
    };

    // Create form data
    const formData = new FormData();
    formData.append('apikey', options.apiKey);
    formData.append('metadata', JSON.stringify(metadata));

    // Add story file
    const storyBlob = typeof storyFile === 'string'
      ? new Blob([storyFile], { type: 'text/html' })
      : new Blob([storyFile], { type: 'application/octet-stream' });
    formData.append('storyfile', storyBlob, 'story.html');

    // Add cover art if available
    if (options.coverArt && fs.existsSync(options.coverArt)) {
      const cover = fs.readFileSync(options.coverArt);
      formData.append('coverart', new Blob([cover]), 'cover.png');
    }

    // Submit to IFDB
    const endpoint = options.tuid
      ? `https://ifdb.org/api/game/${options.tuid}`
      : 'https://ifdb.org/api/game';

    const response = await fetch(endpoint, {
      method: options.tuid ? 'PUT' : 'POST',
      body: formData,
    });

    if (!response.ok) {
      const error = await response.text();
      throw new Error(`IFDB publish failed: ${error}`);
    }

    const result = await response.json();

    return {
      success: true,
      url: `https://ifdb.org/viewgame?id=${result.tuid}`,
      metadata: {
        tuid: result.tuid,
        ifid,
      },
    };
  }

  private isValidIFID(ifid: string): boolean {
    // Treaty of Babel IFID format: UUID or legacy format
    const uuidPattern = /^[0-9A-F]{8}-[0-9A-F]{4}-[0-9A-F]{4}-[0-9A-F]{4}-[0-9A-F]{12}$/i;
    return uuidPattern.test(ifid);
  }
}

3. Add CLI command:

whisker publish --platform=ifdb [options]
  --api-key    IFDB API key (or IFDB_API_KEY env var)
  --tuid       Update existing entry
  --cover      Path to cover art

4. Environment configuration:
   - IFDB_API_KEY environment variable
   - .whiskerrc config file support
```

## Expected Output
~150 lines publisher + ~80 lines tests.

## Verification
```bash
# Dry run (validation only)
whisker publish --platform=ifdb --dry-run

# Actual publish
IFDB_API_KEY=xxx whisker publish --platform=ifdb
```

## Success Criteria
- [ ] IFID validation works
- [ ] Metadata extracted from story
- [ ] Story file uploaded correctly
- [ ] Cover art upload works
- [ ] Update existing entry works
- [ ] Clear error messages for failures

## Next Stage
3.15-itch-publisher.md
