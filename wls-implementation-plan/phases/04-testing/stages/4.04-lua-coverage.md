# Stage 4.04: Lua Test Coverage Expansion

## Objective
Expand Lua tests to 90%+ coverage across all modules.

## Files to Create/Modify
- `spec/**/*_spec.lua`

## Prompt

```
Expand Lua test coverage:

1. Set up coverage tracking:
-- .busted
return {
  default = {
    coverage = true,
    coveralls = true
  }
}

2. Parser coverage (spec/parser/):

describe("ws_parser", function()
  describe("passages", function()
    it("parses simple passage", ...)
    it("parses passage with tags", ...)
    it("handles unicode names", ...)
  end)

  describe("choices", function()
    it("parses basic choice", ...)
    it("parses nested choices", ...)
    it("parses conditional choices", ...)
  end)

  describe("expressions", function()
    it("parses arithmetic", ...)
    it("parses comparisons", ...)
    it("parses boolean logic", ...)
  end)
end)

3. Runtime coverage (spec/runtime/):

describe("player", function()
  describe("navigation", function()
    it("starts at Start", ...)
    it("follows choices", ...)
    it("handles tunnels", ...)
  end)

  describe("variables", function()
    it("sets values", ...)
    it("interpolates", ...)
    it("scopes temp vars", ...)
  end)
end)

4. Validator coverage (spec/validators/):
- All STR, LNK, VAR, EXP, TYP, FLW, QUA codes tested

5. Run coverage report:
busted --coverage
luacov
cat luacov.report.out

Target: 90%+ for all modules
```

## Expected Output
~400 lines of additional tests.

## Verification
```bash
cd ~/code/github.com/writewhisker/whisker-core
busted --coverage
```

## Next Stage
4.05-corpus-expansion.md
