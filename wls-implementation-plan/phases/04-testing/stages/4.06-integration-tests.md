# Stage 4.06: Integration Tests

## Objective
Create end-to-end integration tests.

## Files to Create
- `phase-4-validation/tests/integration/`

## Prompt

```
Create integration tests that verify complete workflows:

1. Create phase-4-validation/tests/integration/:

├── parse-validate-play.test.ts  # Full story lifecycle
├── import-export-round-trip.test.ts
├── cli-workflows.test.ts
└── cross-platform-parity.test.ts

2. Parse-validate-play test:

describe('Story Lifecycle', () => {
  it('parses, validates, and plays a story', async () => {
    const source = fs.readFileSync('examples/adventure.ws', 'utf-8');

    // Parse
    const story = parse(source);
    expect(story.passages.length).toBeGreaterThan(0);

    // Validate
    const validator = createDefaultValidator();
    const result = validator.validate(story);
    expect(result.valid).toBe(true);

    // Play
    const player = new StoryPlayer(story);
    player.start();
    expect(player.getChoices().length).toBeGreaterThan(0);

    // Make choices and verify state
    player.choose(0);
    expect(player.getCurrentPassage()).not.toBe('Start');
  });
});

3. Import-export round-trip:

it('preserves story structure through import/export', async () => {
  // Import Twine
  const twineContent = fs.readFileSync('samples/twine-story.html', 'utf-8');
  const imported = await importManager.import(twineContent, 'twine');

  // Export to HTML
  const exported = await exportManager.export(imported.story, 'html');

  // Verify key content preserved
  expect(exported.content).toContain('Start');
  // Passage count matches
});

4. Cross-platform parity:

it('TypeScript and Lua produce identical results', async () => {
  for (const testCase of corpusTests) {
    const tsResult = runTypeScript(testCase.input);
    const luaResult = runLua(testCase.input);

    expect(tsResult.passages).toEqual(luaResult.passages);
    expect(tsResult.errors).toEqual(luaResult.errors);
  }
});

5. CLI workflow tests:

it('CLI import/export workflow', () => {
  execSync('whisker import sample.html -o output.ws');
  expect(fs.existsSync('output.ws')).toBe(true);

  execSync('whisker export output.ws --to=html -o output.html');
  expect(fs.existsSync('output.html')).toBe(true);
});
```

## Expected Output
~200 lines of integration tests.

## Verification
```bash
cd ~/code/github.com/whisker-language-specification-1.0/phase-4-validation
npm test
```

## Phase 4 Complete
Test coverage targets achieved across all platforms.
