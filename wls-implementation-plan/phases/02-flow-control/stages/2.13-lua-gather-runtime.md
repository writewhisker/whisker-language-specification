# Stage 2.13: Lua Gather Point Runtime

## Objective
Implement gather point execution in Lua runtime.

## Dependencies
- Stage 2.12 (Lua parser complete)

## Files to Modify
- `lib/whisker/runtime/player.lua` (or equivalent runtime file)
- `lib/whisker/core/story_player.lua`

## Prompt

```
Implement gather point execution in Lua runtime:

1. The parser already produces gather data in passage_data.gathers:
   {
     depth = number,      -- Nesting depth (number of - markers)
     content = string,    -- Content after gather point
     location = location  -- Source location
   }

2. Update the Lua player to handle gathers during content rendering:

-- In player.lua or equivalent
local function process_passage_content(passage, state)
  local output = {}
  local current_choice_depth = 0
  local waiting_for_gather = false
  local gather_depth = 0

  for i, element in ipairs(passage.elements) do
    if element.type == "choice" then
      -- Track choice depth
      current_choice_depth = element.depth or 1
      -- After a choice is made, we're waiting for a gather
      waiting_for_gather = true
      gather_depth = current_choice_depth

    elseif element.type == "gather" then
      -- Check if this gather matches our expected depth
      if element.depth == gather_depth then
        waiting_for_gather = false
        -- Render gather content
        table.insert(output, render_content(element.content, state))
      end

    elseif not waiting_for_gather or element.type == "text" then
      -- Render normal content
      table.insert(output, render_content(element, state))
    end
  end

  return table.concat(output)
end

3. Handle nested gathers:
   - Track choice depth stack
   - Match gather depth to choice depth
   - Support multiple gather levels

4. Add state tracking:
   - Remember which choice branch was taken
   - Skip content until matching gather found
```

## Expected Output
~80 lines of Lua runtime code.

## Verification
```bash
cd whisker-core
busted spec/runtime/gather_spec.lua
```

## Success Criteria
- [ ] Single-level gathers work correctly
- [ ] Nested gathers (- -, - - -) work correctly
- [ ] Content after gather is rendered
- [ ] Choice branches reconverge properly

## Next Stage
2.14-lua-tunnel-runtime.md
