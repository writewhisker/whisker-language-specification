# Stage 2.12: Lua - Runtime Flow Control Features

## Objective
Implement gather, tunnel, inline conditional, and once-only execution in Lua runtime.

## Files to Modify
- `lib/whisker/runtime/player.lua`
- `lib/whisker/runtime/state.lua`

## Prompt

```
Update Lua runtime for flow control features:

1. Update lib/whisker/runtime/state.lua:

function State.new()
  return {
    current_passage = nil,
    content_index = 1,
    variables = {},
    local_variables = {},

    -- New for flow control
    call_stack = {},
    max_call_depth = 100,
    seen_once = {},
    choice_depth = 0,
    last_choice_depth = 0
  }
end

2. Update lib/whisker/runtime/player.lua:

-- Gather point handling
function Player:process_gather(node)
  if self.state.last_choice_depth >= node.level then
    -- We came from a choice at this level
    if node.content then
      self:add_output(node.content)
    end
    self.state.choice_depth = node.level - 1
  end
end

-- Tunnel call
function Player:process_tunnel_call(node)
  if #self.state.call_stack >= self.state.max_call_depth then
    error("Call stack overflow: exceeded " .. self.state.max_call_depth)
  end

  -- Push return frame
  table.insert(self.state.call_stack, {
    passage = self.state.current_passage,
    content_index = self.state.content_index + 1,
    local_variables = self:copy_table(self.state.local_variables)
  })

  -- Go to tunnel
  self:navigate_to(node.target)
end

-- Tunnel return
function Player:process_tunnel_return()
  if #self.state.call_stack == 0 then
    error("Tunnel return (->->) without tunnel call")
  end

  local frame = table.remove(self.state.call_stack)
  self.state.current_passage = frame.passage
  self.state.content_index = frame.content_index

  self:continue_from_index()
end

-- Once-only blocks
function Player:process_once_block(node)
  local once_id = self.state.current_passage .. ":" .. node.id

  if not self.state.seen_once[once_id] then
    self.state.seen_once[once_id] = true
    self:process_content(node.content)
  end
end

-- Inline conditionals
function Player:evaluate_inline_conditional(node)
  local result = self:evaluate_expression(node.condition)
  if result then
    return self:render_inline(node.true_content)
  else
    return self:render_inline(node.false_content)
  end
end

-- Update main processing loop
function Player:process_node(node)
  if node.type == "gather" then
    self:process_gather(node)
  elseif node.type == "tunnel_call" then
    self:process_tunnel_call(node)
  elseif node.type == "tunnel_return" then
    self:process_tunnel_return()
  elseif node.type == "once_block" then
    self:process_once_block(node)
  -- ... existing handlers
  end
end

3. Create spec/runtime/flow_control_spec.lua with tests for all features.
```

## Expected Output
~150 lines runtime + ~100 lines tests.

## Verification
```bash
cd ~/code/github.com/writewhisker/whisker-core

busted spec/runtime/flow_control_spec.lua
```

## Next Stage
2.13-corpus-flow-tests.md
