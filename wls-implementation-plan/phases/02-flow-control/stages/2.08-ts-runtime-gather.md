# Stage 2.08: TypeScript - Runtime Gather Points

## Objective
Implement gather point execution in TypeScript runtime.

## Files to Modify
- `packages/story-player/src/StoryPlayer.ts`
- `packages/story-player/src/types.ts`

## Prompt

```
Update the TypeScript runtime to execute gather points:

1. Update packages/story-player/src/types.ts:

export interface RuntimeState {
  // ... existing fields
  choiceDepth: number;  // Current choice nesting level
  pendingGathers: Map<number, GatherNode>;  // Gathers waiting by level
}

2. Update packages/story-player/src/StoryPlayer.ts:

In the content processing loop, handle gather points:

private processContent(content: PassageContent[]): void {
  for (const node of content) {
    switch (node.type) {
      case 'choice':
        this.processChoice(node);
        break;

      case 'gather':
        this.processGather(node);
        break;

      // ... other cases
    }
  }
}

private processChoice(choice: ChoiceNode): void {
  // Track depth when entering nested choices
  this.state.choiceDepth = choice.level ?? 1;

  // Store choice for later selection
  this.state.availableChoices.push({
    ...choice,
    depth: this.state.choiceDepth
  });
}

private processGather(gather: GatherNode): void {
  // Gather collects all choices at its level
  // After a choice is made, execution continues here

  if (this.state.lastChoiceDepth >= gather.level) {
    // We came from a choice at or above this level
    // Process gather content
    if (gather.content) {
      this.processContent(gather.content);
    }

    // Reset depth
    this.state.choiceDepth = gather.level - 1;
  }
}

// When a choice is selected:
public choose(index: number): void {
  const choice = this.state.availableChoices[index];
  this.state.lastChoiceDepth = choice.depth;

  // Process choice content
  this.processContent(choice.content);

  // Continue to gather point
  this.continueToGather(choice.depth);
}

private continueToGather(fromDepth: number): void {
  // Find next gather at or below this depth
  // Continue processing from there
}

3. Create tests:

describe('Gather Point Execution', () => {
  it('continues after gather', () => {
    const player = createPlayer(\`
:: Start
+ [A] You chose A.
+ [B] You chose B.
-
After the choice.
\`);

    player.choose(0);  // Choose A
    const output = player.getOutput();
    expect(output).toContain('You chose A.');
    expect(output).toContain('After the choice.');
  });

  it('handles nested gathers', () => {
    const player = createPlayer(\`
:: Start
+ [Outer]
  ++ [Inner A] Inner A content.
  ++ [Inner B] Inner B content.
  --
  After inner.
-
After outer.
\`);

    player.choose(0);  // Outer
    player.choose(0);  // Inner A
    const output = player.getOutput();
    expect(output).toContain('Inner A content.');
    expect(output).toContain('After inner.');
    expect(output).toContain('After outer.');
  });
});
```

## Expected Output
~100 lines runtime changes + ~80 lines tests.

## Verification
```bash
cd ~/code/github.com/writewhisker/whisker-editor-web

pnpm --filter @writewhisker/story-player test -- --run gather
```

## Next Stage
2.09-ts-runtime-tunnel.md
