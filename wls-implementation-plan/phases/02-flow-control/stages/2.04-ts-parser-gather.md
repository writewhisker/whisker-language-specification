# Stage 2.04: TypeScript - Parser Gather Points

## Objective
Add gather point parsing to TypeScript parser.

## Files to Modify
- `packages/parser/src/whisker.pegjs`
- `packages/story-models/src/types.ts`

## Prompt

```
Update the TypeScript parser to support gather points:

1. Update packages/story-models/src/types.ts - add gather AST node:

export interface GatherNode {
  type: 'gather';
  level: number;  // 1 for -, 2 for --, etc.
  content?: ContentNode[];
  line: number;
}

// Update PassageContent union to include GatherNode
export type PassageContent =
  | TextNode
  | ChoiceNode
  | ConditionalNode
  | GatherNode
  | LinkNode;

2. Update packages/parser/src/whisker.pegjs:

Add gather rule after choice rules:

// Gather point collects choices
Gather
  = level:GatherLevel _ content:InlineContent? EOL {
      return {
        type: 'gather',
        level: level.length,
        content: content || [],
        line: location().start.line
      };
    }

GatherLevel
  = $("-"+)

// Update PassageContent to include Gather
PassageContent
  = Choice
  / Gather  // Add this
  / Conditional
  / Link
  / Text

// Gather must match choice indentation
// This is handled by level counting in the AST

3. Update choice parsing to track indentation level for gather matching.

4. Create tests in packages/parser/src/gather.test.ts:

import { describe, it, expect } from 'vitest';
import { parse } from './index';

describe('Gather Points', () => {
  it('parses simple gather', () => {
    const story = parse(\`
:: Start
+ [A] Text A
+ [B] Text B
-
After gather
\`);
    const passage = story.passages[0];
    // Verify gather node exists after choices
  });

  it('parses nested gather', () => {
    const story = parse(\`
:: Start
+ [Outer]
  ++ [Inner A] A
  ++ [Inner B] B
  --
  After inner
-
After outer
\`);
    // Verify nested structure
  });

  it('parses gather with inline content', () => {
    const story = parse(\`
:: Start
+ [A] A
+ [B] B
- The story continues.
\`);
    // Verify content attached to gather
  });
});
```

## Expected Output
~50 lines types + ~50 lines grammar + ~80 lines tests.

## Verification
```bash
cd ~/code/github.com/writewhisker/whisker-editor-web

pnpm --filter @writewhisker/parser test -- --run gather
```

## Next Stage
2.05-ts-parser-tunnel.md
