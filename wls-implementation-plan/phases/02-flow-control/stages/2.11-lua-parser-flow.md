# Stage 2.11: Lua - Parser Flow Control Features

## Objective
Add gather, tunnel, inline conditional, and once-only parsing to Lua parser.

## Files to Modify
- `lib/whisker/parser/ws_parser.lua`

## Prompt

```
Update the Lua parser to support all flow control features:

1. Add gather point parsing:

function M.parse_gather(line)
  local level = line:match("^(-+)")
  if not level then return nil end

  local content = line:sub(#level + 1):match("^%s*(.-)%s*$")

  return {
    type = "gather",
    level = #level,
    content = content ~= "" and content or nil,
    line = M.current_line
  }
end

2. Add tunnel parsing:

function M.parse_tunnel_call(line)
  local target = line:match("^%->%s*(.-)%s*%->%s*$")
  if target then
    return {
      type = "tunnel_call",
      target = target,
      line = M.current_line
    }
  end
  return nil
end

function M.parse_tunnel_return(line)
  if line:match("^%->%->%s*$") then
    return {
      type = "tunnel_return",
      line = M.current_line
    }
  end
  return nil
end

3. Add inline conditional parsing:

function M.parse_inline_conditional(text)
  -- Pattern: {condition ? true | false}
  local pattern = "{(.-)%s*%?%s*(.-)%s*|%s*(.-)}"
  local results = {}
  local last_end = 1

  for condition, true_text, false_text, pos in text:gmatch(pattern .. "()") do
    -- Add text before this conditional
    if pos > last_end then
      table.insert(results, {
        type = "text",
        value = text:sub(last_end, pos - #condition - #true_text - #false_text - 5)
      })
    end

    table.insert(results, {
      type = "inline_conditional",
      condition = M.parse_expression(condition),
      true_content = true_text,
      false_content = false_text
    })

    last_end = pos
  end

  -- Add remaining text
  if last_end <= #text then
    table.insert(results, { type = "text", value = text:sub(last_end) })
  end

  return results
end

4. Add once-only block parsing:

function M.parse_once_block(lines, start_index)
  if not lines[start_index]:match("^{once}") then
    return nil, start_index
  end

  local content = {}
  local i = start_index + 1

  while i <= #lines and not lines[i]:match("^{/once}") do
    local node = M.parse_line(lines[i])
    if node then table.insert(content, node) end
    i = i + 1
  end

  return {
    type = "once_block",
    content = content,
    id = "once_" .. start_index,
    line = start_index
  }, i + 1
end

5. Update main parsing loop to check for new constructs:

function M.parse_line(line)
  -- Check tunnel return first (before tunnel call)
  local tunnel_return = M.parse_tunnel_return(line)
  if tunnel_return then return tunnel_return end

  -- Check tunnel call (before regular link)
  local tunnel_call = M.parse_tunnel_call(line)
  if tunnel_call then return tunnel_call end

  -- Check gather
  local gather = M.parse_gather(line)
  if gather then return gather end

  -- ... existing parsing
end
```

## Expected Output
~150 lines of parser changes.

## Verification
```bash
cd ~/code/github.com/writewhisker/whisker-core

lua -e "
local parser = require('whisker.parser.ws_parser')
local story = parser.parse([[
:: Start
+ [A] A
+ [B] B
-
After gather
-> Tunnel ->
{once}
First time
{/once}

:: Tunnel
->->
]])
print('Passages:', #story.passages)
"
```

## Next Stage
2.12-lua-runtime-flow.md
