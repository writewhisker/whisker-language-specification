# Stage 2.07: TypeScript - Parser Once-Only Blocks

## Objective
Add once-only block parsing to TypeScript parser.

## Files to Modify
- `packages/parser/src/whisker.pegjs`
- `packages/story-models/src/types.ts`

## Prompt

```
Update the TypeScript parser to support once-only blocks:

1. Update packages/story-models/src/types.ts:

export interface OnceBlockNode {
  type: 'once_block';
  content: PassageContent[];
  id: string;  // Unique identifier for tracking
  line: number;
}

2. Update packages/parser/src/whisker.pegjs:

// Once-only block
OnceBlock
  = "{once}" EOL content:OnceContent "{/once}" EOL? {
      return {
        type: 'once_block',
        content: content,
        id: `once_${location().start.line}`,
        line: location().start.line
      };
    }

OnceContent
  = lines:(!"{/once}" PassageContent)* {
      return lines.map(l => l[1]);
    }

// Alternative single-line form
OnceBlockInline
  = "{once}" content:InlineContent "{/once}" {
      return {
        type: 'once_block',
        content: [{ type: 'text', value: content }],
        id: `once_${location().start.line}`,
        line: location().start.line
      };
    }

// Add to PassageContent
PassageContent
  = OnceBlock
  / Choice
  / Gather
  / Conditional
  / TunnelReturn
  / TunnelCall
  / Link
  / Text

3. Create tests:

describe('Once-Only Blocks', () => {
  it('parses once block', () => {
    const story = parse(\`
:: Start
{once}
First time only.
{/once}
Always shown.
\`);
    const passage = story.passages[0];
    const onceBlock = passage.content.find(n => n.type === 'once_block');
    expect(onceBlock).toBeDefined();
  });

  it('generates unique IDs', () => {
    const story = parse(\`
:: Start
{once}
Block 1
{/once}
{once}
Block 2
{/once}
\`);
    const onces = story.passages[0].content.filter(n => n.type === 'once_block');
    expect(onces[0].id).not.toBe(onces[1].id);
  });

  it('parses once with choices', () => {
    const story = parse(\`
:: Start
{once}
+ [First time choice] -> A
{/once}
+ [Always available] -> B
\`);
  });

  it('parses nested content in once', () => {
    const story = parse(\`
:: Start
{once}
{$hasKey}
You notice a keyhole.
{/}
{/once}
\`);
  });
});
```

## Expected Output
~30 lines types + ~40 lines grammar + ~60 lines tests.

## Verification
```bash
cd ~/code/github.com/writewhisker/whisker-editor-web

pnpm --filter @writewhisker/parser test -- --run once
```

## Next Stage
2.08-ts-runtime-gather.md
