#!/bin/bash
# claude-wls: Launch Claude Code with WLS stage execution context
#
# Usage:
#   claude-wls stage 2.13       # Execute stage 2.13
#   claude-wls phase 2          # Execute all Phase 2 remaining stages
#   claude-wls group E          # Execute parallel group E (one stage in this window)

set -e

WLS_SPEC="${WLS_SPEC:-$HOME/code/github.com/whisker-language-specification-1.0}"
WLS_TS="${WLS_TS:-$HOME/code/github.com/writewhisker/whisker-editor-web}"
WLS_LUA="${WLS_LUA:-$HOME/code/github.com/writewhisker/whisker-core}"
PLAN_DIR="$WLS_SPEC/wls-implementation-plan"

# Get repository for a stage
get_repo() {
  local stage=$1
  local major="${stage%%.*}"
  local minor="${stage#*.}"

  case "$major" in
    1)
      case "$minor" in
        0[1-5]|2[0-2]) echo "$WLS_SPEC" ;;
        0[6-9]|1[0-3]) echo "$WLS_TS" ;;
        1[4-9]) echo "$WLS_LUA" ;;
        *) echo "$WLS_TS" ;;
      esac
      ;;
    2)
      case "$minor" in
        0[1-3]|15) echo "$WLS_SPEC" ;;
        0[4-9]|10) echo "$WLS_TS" ;;
        1[1-4]) echo "$WLS_LUA" ;;
        *) echo "$WLS_TS" ;;
      esac
      ;;
    3) echo "$WLS_TS" ;;
    *) echo "$WLS_TS" ;;
  esac
}

# Get phase directory name
get_phase_dir() {
  local phase=$1
  case "$phase" in
    1) echo "01-validation" ;;
    2) echo "02-flow-control" ;;
    3) echo "03-tooling" ;;
    4) echo "04-testing" ;;
    5) echo "05-documentation" ;;
    6) echo "06-wls-2.0" ;;
  esac
}

# Find stage file
find_stage_file() {
  local stage=$1
  local major="${stage%%.*}"
  local phase_dir=$(get_phase_dir "$major")
  find "$PLAN_DIR/phases/$phase_dir/stages" -name "${stage}-*.md" 2>/dev/null | head -1
}

# Execute a single stage
execute_stage() {
  local stage=$1
  local stage_file=$(find_stage_file "$stage")
  local repo=$(get_repo "$stage")

  if [ -z "$stage_file" ] || [ ! -f "$stage_file" ]; then
    echo "Error: Stage file not found for $stage"
    echo "Looked in: $PLAN_DIR/phases/*/stages/${stage}-*.md"
    exit 1
  fi

  echo "==========================================="
  echo "WLS Stage Execution: $stage"
  echo "==========================================="
  echo "Stage file: $stage_file"
  echo "Repository: $repo"
  echo "-------------------------------------------"
  echo ""

  cd "$repo"

  # Build the prompt for Claude
  local prompt="Execute WLS stage $stage.

Read the CLAUDE.md file at $PLAN_DIR/CLAUDE.md for the Stage Execution Protocol.

Then read the stage file at $stage_file and implement it completely:

1. Create feature branch: feature/wls-stage-$stage
2. Implement all changes described in the stage file
3. Run tests and verify all success criteria pass
4. Commit with proper message format
5. Push and create PR
6. Report completion with PR URL

Start now."

  # Launch claude in the repo with the prompt
  claude --print "$prompt"
}

# Show parallel execution instructions
execute_parallel() {
  local group=$1
  local stages=""

  case "$group" in
    E) stages="3.11 3.12 3.13 3.16" ;;
    F) stages="3.14 3.15 3.17" ;;
    A) stages="1.08 1.09 1.10 1.11" ;;
    B) stages="2.04 2.05 2.06 2.07" ;;
    *)
      echo "Unknown group: $group"
      echo "Available: A, B, E, F"
      exit 1
      ;;
  esac

  echo "==========================================="
  echo "Parallel Execution: Group $group"
  echo "==========================================="
  echo ""
  echo "Open these terminal windows and run:"
  echo ""

  local n=1
  for stage in $stages; do
    local repo=$(get_repo "$stage")
    echo "Window $n:"
    echo "  cd $repo && claude-wls stage $stage"
    echo ""
    ((n++))
  done

  echo "All windows can run simultaneously."
}

# List all stages in a phase
list_phase() {
  local phase=$1
  local phase_dir=$(get_phase_dir "$phase")
  local stage_dir="$PLAN_DIR/phases/$phase_dir/stages"

  echo "==========================================="
  echo "Phase $phase Stages"
  echo "==========================================="
  echo ""

  if [ -d "$stage_dir" ]; then
    for f in "$stage_dir"/*.md; do
      if [ -f "$f" ]; then
        local name=$(basename "$f" .md)
        echo "  $name"
      fi
    done
  else
    echo "No stages found in $stage_dir"
  fi

  echo ""
  echo "Run: claude-wls stage <X.XX>"
}

# Main
case "$1" in
  stage)
    [ -z "$2" ] && { echo "Usage: claude-wls stage <X.XX>"; exit 1; }
    execute_stage "$2"
    ;;
  phase)
    [ -z "$2" ] && { echo "Usage: claude-wls phase <N>"; exit 1; }
    list_phase "$2"
    ;;
  group)
    [ -z "$2" ] && { echo "Usage: claude-wls group <A|B|E|F>"; exit 1; }
    execute_parallel "$2"
    ;;
  *)
    echo "WLS Claude Executor"
    echo ""
    echo "Usage:"
    echo "  claude-wls stage <X.XX>    Execute a single stage"
    echo "  claude-wls phase <N>       List stages in phase N"
    echo "  claude-wls group <A-F>     Show parallel group setup"
    echo ""
    echo "Examples:"
    echo "  claude-wls stage 2.13      # Execute stage 2.13"
    echo "  claude-wls phase 3         # List Phase 3 stages"
    echo "  claude-wls group E         # Setup for Group E parallel execution"
    ;;
esac
