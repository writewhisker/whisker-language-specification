#!/bin/bash
# WLS Stage Executor
# Usage: wls-execute <stage|phase|group> [target]
#
# Examples:
#   wls-execute stage 2.13       # Execute single stage
#   wls-execute phase 2          # Execute all Phase 2 stages
#   wls-execute group E          # Execute parallel group E
#   wls-execute next             # Execute next pending stage

set -e

# Configuration
WLS_SPEC="${WLS_SPEC:-$HOME/code/github.com/whisker-language-specification-1.0}"
WLS_TS="${WLS_TS:-$HOME/code/github.com/writewhisker/whisker-editor-web}"
WLS_LUA="${WLS_LUA:-$HOME/code/github.com/writewhisker/whisker-core}"
PLAN_DIR="$WLS_SPEC/wls-implementation-plan"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Stage to repository mapping
get_repo() {
  local stage=$1
  local major="${stage%%.*}"
  local minor="${stage#*.}"

  case "$major" in
    1)
      case "$minor" in
        0[1-5]) echo "$WLS_SPEC" ;;
        0[6-9]|1[0-3]) echo "$WLS_TS" ;;
        1[4-9]) echo "$WLS_LUA" ;;
        2[0-2]) echo "$WLS_SPEC" ;;
        *) echo "$WLS_TS" ;;
      esac
      ;;
    2)
      case "$minor" in
        0[1-3]) echo "$WLS_SPEC" ;;
        0[4-9]|10) echo "$WLS_TS" ;;
        1[1-4]) echo "$WLS_LUA" ;;
        15) echo "$WLS_SPEC" ;;
        *) echo "$WLS_TS" ;;
      esac
      ;;
    3) echo "$WLS_TS" ;;
    4) echo "$WLS_TS" ;;  # Most Phase 4 is TS
    5) echo "$WLS_SPEC" ;;
    6) echo "$WLS_TS" ;;  # Most Phase 6 is TS
    *) echo "$WLS_TS" ;;
  esac
}

# Get phase directory
get_phase_dir() {
  local stage=$1
  local major="${stage%%.*}"

  case "$major" in
    1) echo "01-validation" ;;
    2) echo "02-flow-control" ;;
    3) echo "03-tooling" ;;
    4) echo "04-testing" ;;
    5) echo "05-documentation" ;;
    6) echo "06-wls-2.0" ;;
    *) echo "" ;;
  esac
}

# Find stage file
find_stage_file() {
  local stage=$1
  local phase_dir=$(get_phase_dir "$stage")
  local stage_dir="$PLAN_DIR/phases/$phase_dir/stages"

  # Handle stage numbers like 2.13 -> 2.13-*
  local stage_pattern="${stage}-*.md"

  find "$stage_dir" -name "$stage_pattern" 2>/dev/null | head -1
}

# List stages for a phase
list_phase_stages() {
  local phase=$1
  local phase_dir=$(get_phase_dir "${phase}.01")
  local stage_dir="$PLAN_DIR/phases/$phase_dir/stages"

  if [ -d "$stage_dir" ]; then
    ls "$stage_dir"/*.md 2>/dev/null | xargs -n1 basename | sed 's/\.md$//' | sort -V
  fi
}

# Get parallel group stages
get_group_stages() {
  local group=$1

  case "$group" in
    A) echo "1.08 1.09 1.10 1.11" ;;
    B) echo "2.04 2.05 2.06 2.07" ;;
    C) echo "4.01 4.02 4.03 4.04" ;;
    D) echo "6.04 6.05 6.06 6.08 6.09" ;;
    E) echo "3.11 3.12 3.13 3.16" ;;
    F) echo "3.14 3.15 3.17" ;;
    *) echo "" ;;
  esac
}

# Execute a single stage
execute_stage() {
  local stage=$1
  local stage_file=$(find_stage_file "$stage")
  local repo=$(get_repo "$stage")

  if [ -z "$stage_file" ]; then
    echo -e "${RED}Error: Stage file not found for $stage${NC}"
    exit 1
  fi

  echo -e "${BLUE}========================================${NC}"
  echo -e "${GREEN}Executing Stage $stage${NC}"
  echo -e "${BLUE}========================================${NC}"
  echo -e "Stage file: ${YELLOW}$stage_file${NC}"
  echo -e "Repository: ${YELLOW}$repo${NC}"
  echo ""

  # Change to the repository
  cd "$repo"

  # Read stage file content
  local stage_content=$(cat "$stage_file")

  # Launch Claude with the execution prompt
  local prompt="Execute stage $stage.

Read this stage file and implement it completely:

$stage_content

Follow the Stage Execution Protocol from CLAUDE.md:
1. Create feature branch feature/wls-stage-$stage
2. Implement all files listed in 'Files to Create/Modify'
3. Run verification commands
4. Check all success criteria
5. Commit with proper message
6. Create PR

Report when complete with PR URL and success criteria status."

  echo -e "${GREEN}Launching Claude Code...${NC}"
  echo ""

  # Execute claude with the prompt
  claude --print "$prompt"
}

# Execute multiple stages for parallel execution
execute_parallel_info() {
  local stages="$1"

  echo -e "${BLUE}========================================${NC}"
  echo -e "${GREEN}Parallel Execution Setup${NC}"
  echo -e "${BLUE}========================================${NC}"
  echo ""
  echo "Open separate terminal windows and run:"
  echo ""

  local window=1
  for stage in $stages; do
    local repo=$(get_repo "$stage")
    echo -e "${YELLOW}Window $window:${NC}"
    echo "  cd $repo"
    echo "  wls-execute stage $stage"
    echo ""
    ((window++))
  done

  echo -e "${GREEN}All stages can run simultaneously.${NC}"
}

# Main command handler
case "$1" in
  stage)
    if [ -z "$2" ]; then
      echo "Usage: wls-execute stage <X.XX>"
      exit 1
    fi
    execute_stage "$2"
    ;;

  phase)
    if [ -z "$2" ]; then
      echo "Usage: wls-execute phase <N>"
      exit 1
    fi
    echo -e "${GREEN}Stages in Phase $2:${NC}"
    list_phase_stages "$2"
    echo ""
    echo -e "Run: ${YELLOW}wls-execute stage <X.XX>${NC} for each stage"
    ;;

  group)
    if [ -z "$2" ]; then
      echo "Usage: wls-execute group <A|B|C|D|E|F>"
      exit 1
    fi
    stages=$(get_group_stages "$2")
    if [ -z "$stages" ]; then
      echo "Unknown group: $2"
      exit 1
    fi
    execute_parallel_info "$stages"
    ;;

  list)
    echo -e "${GREEN}Available Phases:${NC}"
    echo "  1 - Validation"
    echo "  2 - Flow Control"
    echo "  3 - Tooling"
    echo "  4 - Testing"
    echo "  5 - Documentation"
    echo "  6 - WLS 2.0"
    echo ""
    echo -e "${GREEN}Available Parallel Groups:${NC}"
    echo "  A - TS Validators (1.08-1.11)"
    echo "  B - TS Parsers (2.04-2.07)"
    echo "  C - Coverage (4.01-4.04)"
    echo "  D - WLS 2.0 Features (6.04-6.09)"
    echo "  E - Extended Tooling (3.11, 3.12, 3.13, 3.16)"
    echo "  F - Publishing (3.14, 3.15, 3.17)"
    ;;

  status)
    echo -e "${GREEN}Checking stage completion status...${NC}"
    echo ""
    for repo in "$WLS_TS" "$WLS_LUA" "$WLS_SPEC"; do
      if [ -d "$repo/.git" ]; then
        echo -e "${YELLOW}$(basename $repo):${NC}"
        cd "$repo"
        git log --oneline --grep="Stage" 2>/dev/null | head -10
        echo ""
      fi
    done
    ;;

  *)
    echo "WLS Stage Executor"
    echo ""
    echo "Usage:"
    echo "  wls-execute stage <X.XX>    Execute a single stage"
    echo "  wls-execute phase <N>       List stages in a phase"
    echo "  wls-execute group <A-F>     Show parallel group setup"
    echo "  wls-execute list            List all phases and groups"
    echo "  wls-execute status          Show completed stages"
    echo ""
    echo "Examples:"
    echo "  wls-execute stage 2.13"
    echo "  wls-execute phase 3"
    echo "  wls-execute group E"
    ;;
esac
